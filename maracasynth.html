<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>8-Voice Frequency Synth (WebAudio)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#101826;
      --panel2:#0f1520;
      --txt:#e7eefc;
      --muted:#92a4c6;
      --accent:#4ea1ff;
      --accent2:#6af0c2;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --ok:#4bf08a;
      --br:16px;
      --gap:12px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --line: 1px solid rgba(255,255,255,.08);
      font-synthesis-weight: none;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 40% 20%, rgba(78,161,255,.12), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(106,240,194,.10), transparent 55%),
                  var(--bg);
      color:var(--txt);
      overflow-x:hidden;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:18px;
      padding-bottom:40px;
    }
    header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:260px;
    }
    .title h1{
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
    }
    .title p{
      margin:0;
      color:var(--muted);
      font-size:12.5px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: var(--line);
      border-radius: var(--br);
      box-shadow: var(--shadow);
    }
    .top{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    @media (max-width: 900px){
      .top{grid-template-columns:1fr}
    }
    .controls{
      padding:14px;
    }
    .controls .row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      margin-top:10px;
    }
    .btn{
      appearance:none;
      border: var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(78,161,255,.55);
      background: rgba(78,161,255,.16);
    }
    .btn.danger{
      border-color: rgba(255,92,122,.55);
      background: rgba(255,92,122,.14);
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border: var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill b{color:var(--txt)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 560px){
      .grid2{grid-template-columns:1fr}
    }
    .kv{
      padding:10px;
      border-radius: 14px;
      border: var(--line);
      background: rgba(0,0,0,.18);
    }
    .kv label{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    input[type="number"], select{
      width:100%;
      padding:9px 10px;
      border-radius: 12px;
      border: var(--line);
      background: rgba(0,0,0,.25);
      color: var(--txt);
      outline:none;
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }
    .scope{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    canvas{
      width:100%;
      height:150px;
      border-radius: 14px;
      border: var(--line);
      background: rgba(0,0,0,.25);
    }

    .voices{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--gap);
    }
    @media (max-width: 900px){
      .voices{grid-template-columns:1fr}
    }
    .voice{
      padding:14px;
    }
    .voiceHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .voiceHead .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:200px;
    }
    .badge{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      border: var(--line);
      background: rgba(255,255,255,.05);
      font-weight:800;
      color: var(--txt);
    }
    .toggles{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      border: var(--line);
      background: rgba(255,255,255,.04);
      color: var(--txt);
      padding:8px 10px;
      border-radius: 999px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      transition: background .15s ease, border-color .15s ease, transform .06s ease;
    }
    .chip:hover{background: rgba(255,255,255,.08)}
    .chip:active{transform: translateY(1px)}
    .chip.on{
      border-color: rgba(106,240,194,.55);
      background: rgba(106,240,194,.14);
    }
    .chip.solo.on{
      border-color: rgba(255,204,102,.65);
      background: rgba(255,204,102,.16);
    }

    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 700px){
      .row3{grid-template-columns:1fr}
    }

    .footerNote{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>8-Voice Frequency Synth</h1>
      <p>WebAudio ‚Ä¢ Somma fino a 8 voci ‚Ä¢ Limiter anti-clipping ‚Ä¢ ADSR ‚Ä¢ Pan</p>
    </div>
    <div class="pill"><span>Stato:</span> <b id="status">STOP</b> <span class="mono" id="sr"></span></div>
  </header>

  <section class="top">
    <div class="card controls">
      <div class="row" style="margin-top:0; justify-content:space-between;">
        <div class="row" style="margin-top:0;">
          <button class="btn primary" id="btnStart">‚ñ∂Ô∏è Start</button>
          <button class="btn danger" id="btnStop" disabled>‚èπ Stop</button>
          <button class="btn" id="btnPanic" title="Silenzia subito e reset envelope">üßØ Panic</button>
        </div>
        <div class="pill" title="Somma delle voci (pre-limiter) e livello in uscita (post-limiter)">
          <span>Mix:</span> <b id="mixInfo">‚Äî</b>
        </div>
      </div>

      <div class="grid2">
        <div class="kv">
          <label>
            <span>Master Volume</span>
            <span class="mono" id="masterVal">0.35</span>
          </label>
          <input id="master" type="range" min="0" max="1" step="0.001" value="0.35">
          <div class="small">Consiglio: tienilo basso se alzi i gain delle voci.</div>
        </div>

        <div class="kv">
          <label>
            <span>Limiter (Threshold)</span>
            <span class="mono" id="limVal">-6 dB</span>
          </label>
          <input id="limiter" type="range" min="-24" max="-1" step="1" value="-6">
          <div class="small">Limiter soft-knee con compressor. Riduce il clipping quando sommi pi√π voci.</div>
        </div>
      </div>

      <div class="row3">
        <div class="kv">
          <label><span>Attack</span><span class="mono" id="aVal">0.01 s</span></label>
          <input id="atk" type="range" min="0.001" max="2" step="0.001" value="0.01">
        </div>
        <div class="kv">
          <label><span>Decay</span><span class="mono" id="dVal">0.15 s</span></label>
          <input id="dec" type="range" min="0.001" max="2" step="0.001" value="0.15">
        </div>
        <div class="kv">
          <label><span>Sustain</span><span class="mono" id="sVal">0.70</span></label>
          <input id="sus" type="range" min="0" max="1" step="0.001" value="0.70">
        </div>
      </div>

      <div class="row3">
        <div class="kv">
          <label><span>Release</span><span class="mono" id="rVal">0.25 s</span></label>
          <input id="rel" type="range" min="0.001" max="3" step="0.001" value="0.25">
        </div>
        <div class="kv">
          <label><span>Global Detune</span><span class="mono" id="gDetVal">0 cents</span></label>
          <input id="gDet" type="range" min="-50" max="50" step="1" value="0">
        </div>
        <div class="kv">
          <label><span>Preset</span><span class="mono">Quick</span></label>
          <div style="display:flex; gap:10px;">
            <button class="btn" id="presetChord" style="flex:1;">üéπ Chord</button>
            <button class="btn" id="presetHarm" style="flex:1;">üéª Harm</button>
          </div>
        </div>
      </div>

      <div class="footerNote">
        Nota: su alcuni browser l‚Äôaudio parte solo dopo un click (Start). ‚ÄúPanic‚Äù forza volume a zero e resetta.
      </div>
    </div>

    <div class="card scope">
      <div class="row" style="margin-top:0; justify-content:space-between;">
        <div class="pill"><span>Oscilloscopio</span></div>
        <div class="pill"><span>FPS:</span> <b id="fps">‚Äî</b></div>
      </div>
      <canvas id="scope" width="900" height="260"></canvas>
      <div class="small">
        Visualizza il segnale in uscita (post-limiter). Se vedi la forma ‚Äútagliata‚Äù, abbassa master o i gain.
      </div>
    </div>
  </section>

  <section class="voices" id="voices"></section>

  <div class="footerNote">
    Suggerimento: per generare ‚Äúfrequenze multiple‚Äù, attiva pi√π voci e imposta frequenze diverse (es. 440, 550, 660‚Ä¶).
  </div>
</div>

<script>
(() => {
  const MAX_VOICES = 8;

  // ---------- UI refs ----------
  const el = (id) => document.getElementById(id);
  const statusEl = el("status");
  const srEl = el("sr");
  const mixInfoEl = el("mixInfo");
  const masterEl = el("master");
  const masterValEl = el("masterVal");
  const limiterEl = el("limiter");
  const limValEl = el("limVal");
  const atkEl = el("atk"), decEl = el("dec"), susEl = el("sus"), relEl = el("rel");
  const aValEl = el("aVal"), dValEl = el("dVal"), sValEl = el("sVal"), rValEl = el("rVal");
  const gDetEl = el("gDet"), gDetValEl = el("gDetVal");
  const btnStart = el("btnStart"), btnStop = el("btnStop"), btnPanic = el("btnPanic");
  const presetChord = el("presetChord"), presetHarm = el("presetHarm");
  const canvas = el("scope");
  const ctx2d = canvas.getContext("2d");
  const fpsEl = el("fps");
  const voicesRoot = el("voices");

  // ---------- Audio graph ----------
  let ac = null;
  let masterGain = null;
  let compressor = null;
  let analyser = null;

  // Per voice: osc -> gain -> panner -> mixBus
  const voices = [];

  const state = {
    running: false,
    adsr: { a: +atkEl.value, d: +decEl.value, s: +susEl.value, r: +relEl.value },
    globalDetune: +gDetEl.value
  };

  function dbToLin(db){ return Math.pow(10, db/20); }

  function ensureAudio() {
    if (ac) return;

    ac = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: "interactive" });

    masterGain = ac.createGain();
    masterGain.gain.value = +masterEl.value;

    // Soft limiter via compressor
    compressor = ac.createDynamicsCompressor();
    compressor.threshold.value = +limiterEl.value; // dB
    compressor.knee.value = 18;
    compressor.ratio.value = 8;
    compressor.attack.value = 0.002;
    compressor.release.value = 0.12;

    analyser = ac.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.85;

    // chain: mix -> compressor -> master -> analyser -> destination
    // We'll connect voices to compressor directly (mix bus).
    compressor.connect(masterGain);
    masterGain.connect(analyser);
    analyser.connect(ac.destination);

    srEl.textContent = ` ‚Ä¢ ${Math.round(ac.sampleRate)} Hz`;

    // build voices
    for (let i = 0; i < MAX_VOICES; i++) {
      const osc = ac.createOscillator();
      osc.type = "sine";
      osc.frequency.value = 440;
      osc.detune.value = 0;

      const vGain = ac.createGain();
      vGain.gain.value = 0.0; // envelope controlled

      const panner = ac.createStereoPanner();
      panner.pan.value = 0;

      osc.connect(vGain).connect(panner).connect(compressor);
      osc.start();

      voices.push({
        idx: i+1,
        osc,
        gain: vGain,
        panner,
        ui: null,
        params: {
          on: false,
          solo: false,
          mute: false,
          waveform: "sine",
          freq: 440,
          detune: 0,
          level: 0.20, // target peak (pre envelope)
          pan: 0
        }
      });
    }

    buildVoiceUI();
    updateMixInfo();
  }

  // ---------- Envelope helpers ----------
  function now() { return ac ? ac.currentTime : 0; }

  function applyVoiceParams(v) {
    v.osc.type = v.params.waveform;
    v.osc.frequency.setValueAtTime(v.params.freq, now());
    v.osc.detune.setValueAtTime(v.params.detune + state.globalDetune, now());
    v.panner.pan.setValueAtTime(v.params.pan, now());
  }

  function voiceTargetGain(v) {
    // If solo is active on any voice, only solo voices pass (unless muted).
    const anySolo = voices.some(x => x.params.solo);
    if (anySolo && !v.params.solo) return 0;
    if (!v.params.on) return 0;
    if (v.params.mute) return 0;
    return v.params.level;
  }

  function envOn(v) {
    const t = now();
    const {a,d,s} = state.adsr;

    const target = voiceTargetGain(v);
    v.gain.gain.cancelScheduledValues(t);

    // Start from current value (prevents clicks if retrigger)
    const current = v.gain.gain.value;
    v.gain.gain.setValueAtTime(current, t);

    // Attack to target
    v.gain.gain.linearRampToValueAtTime(target, t + a);

    // Decay to sustain level (relative to target)
    const susLevel = target * s;
    v.gain.gain.linearRampToValueAtTime(susLevel, t + a + d);
  }

  function envOff(v) {
    const t = now();
    const {r} = state.adsr;
    v.gain.gain.cancelScheduledValues(t);
    v.gain.gain.setValueAtTime(v.gain.gain.value, t);
    v.gain.gain.linearRampToValueAtTime(0.0, t + r);
  }

  function refreshAllEnvelopes() {
    // Called when solo/mute/master changes etc.
    if (!ac) return;
    voices.forEach(v => {
      applyVoiceParams(v);
      const tgt = voiceTargetGain(v);
      // Smoothly approach new target (keep sustain feel)
      const t = now();
      v.gain.gain.cancelScheduledValues(t);
      v.gain.gain.setValueAtTime(v.gain.gain.value, t);
      v.gain.gain.linearRampToValueAtTime(tgt * state.adsr.s, t + 0.03);
    });
    updateMixInfo();
  }

  // ---------- UI building ----------
  function buildVoiceUI() {
    voicesRoot.innerHTML = "";
    voices.forEach(v => {
      const card = document.createElement("div");
      card.className = "card voice";
      card.innerHTML = `
        <div class="voiceHead">
          <div class="left">
            <div class="badge">${v.idx}</div>
            <div style="display:flex; flex-direction:column; gap:2px;">
              <div style="font-weight:800; letter-spacing:.2px;">Voice ${v.idx}</div>
              <div class="small mono" id="vInfo_${v.idx}">freq 440 Hz ‚Ä¢ gain 0.20 ‚Ä¢ pan 0</div>
            </div>
          </div>
          <div class="toggles">
            <button class="chip on" id="vOn_${v.idx}">ON</button>
            <button class="chip" id="vMute_${v.idx}">MUTE</button>
            <button class="chip solo" id="vSolo_${v.idx}">SOLO</button>
          </div>
        </div>

        <div class="row3">
          <div class="kv">
            <label><span>Waveform</span><span class="mono" id="vWaveLbl_${v.idx}">${v.params.waveform}</span></label>
            <select id="vWave_${v.idx}">
              <option value="sine">sine</option>
              <option value="triangle">triangle</option>
              <option value="sawtooth">sawtooth</option>
              <option value="square">square</option>
            </select>
          </div>

          <div class="kv">
            <label><span>Frequency</span><span class="mono" id="vFreqLbl_${v.idx}">440 Hz</span></label>
            <input id="vFreq_${v.idx}" type="range" min="20" max="2000" step="1" value="440">
            <div style="display:flex; gap:10px; margin-top:8px;">
              <input id="vFreqNum_${v.idx}" type="number" min="1" max="20000" step="1" value="440">
              <button class="btn" id="vA4_${v.idx}" title="Set 440 Hz">A4</button>
            </div>
          </div>

          <div class="kv">
            <label><span>Level</span><span class="mono" id="vLvlLbl_${v.idx}">0.20</span></label>
            <input id="vLvl_${v.idx}" type="range" min="0" max="1" step="0.001" value="${v.params.level}">
            <div class="small">Questo √® il livello ‚Äúbase‚Äù prima dell‚ÄôADSR.</div>
          </div>
        </div>

        <div class="row3">
          <div class="kv">
            <label><span>Detune</span><span class="mono" id="vDetLbl_${v.idx}">0 cents</span></label>
            <input id="vDet_${v.idx}" type="range" min="-1200" max="1200" step="1" value="0">
          </div>

          <div class="kv">
            <label><span>Pan</span><span class="mono" id="vPanLbl_${v.idx}">0</span></label>
            <input id="vPan_${v.idx}" type="range" min="-1" max="1" step="0.001" value="0">
          </div>

          <div class="kv">
            <label><span>Quick</span><span class="mono">Actions</span></label>
            <div style="display:flex; gap:10px;">
              <button class="btn" id="vTrig_${v.idx}" style="flex:1;">üîä Trigger</button>
              <button class="btn" id="vOff_${v.idx}" style="flex:1;">üîá Off</button>
            </div>
          </div>
        </div>
      `;

      voicesRoot.appendChild(card);

      // Bind UI
      const onBtn = el(`vOn_${v.idx}`);
      const muteBtn = el(`vMute_${v.idx}`);
      const soloBtn = el(`vSolo_${v.idx}`);
      const waveSel = el(`vWave_${v.idx}`);
      const freqR = el(`vFreq_${v.idx}`);
      const freqN = el(`vFreqNum_${v.idx}`);
      const a4Btn = el(`vA4_${v.idx}`);
      const lvlR = el(`vLvl_${v.idx}`);
      const detR = el(`vDet_${v.idx}`);
      const panR = el(`vPan_${v.idx}`);
      const trigBtn = el(`vTrig_${v.idx}`);
      const offBtn = el(`vOff_${v.idx}`);

      function syncInfo() {
        el(`vWaveLbl_${v.idx}`).textContent = v.params.waveform;
        el(`vFreqLbl_${v.idx}`).textContent = `${Math.round(v.params.freq)} Hz`;
        el(`vLvlLbl_${v.idx}`).textContent = v.params.level.toFixed(2);
        el(`vDetLbl_${v.idx}`).textContent = `${v.params.detune|0} cents`;
        el(`vPanLbl_${v.idx}`).textContent = `${v.params.pan.toFixed(2)}`;
        el(`vInfo_${v.idx}`).textContent =
          `freq ${Math.round(v.params.freq)} Hz ‚Ä¢ gain ${v.params.level.toFixed(2)} ‚Ä¢ pan ${v.params.pan.toFixed(2)}`;

        onBtn.classList.toggle("on", v.params.on);
        muteBtn.classList.toggle("on", v.params.mute);
        soloBtn.classList.toggle("on", v.params.solo);
        onBtn.textContent = v.params.on ? "ON" : "OFF";
      }

      onBtn.addEventListener("click", () => {
        v.params.on = !v.params.on;
        syncInfo();
        if (!ac) return;
        applyVoiceParams(v);
        if (v.params.on) envOn(v); else envOff(v);
        refreshAllEnvelopes();
      });

      muteBtn.addEventListener("click", () => {
        v.params.mute = !v.params.mute;
        syncInfo();
        refreshAllEnvelopes();
      });

      soloBtn.addEventListener("click", () => {
        v.params.solo = !v.params.solo;
        syncInfo();
        refreshAllEnvelopes();
      });

      waveSel.addEventListener("change", () => {
        v.params.waveform = waveSel.value;
        syncInfo();
        if (ac) applyVoiceParams(v);
      });

      function setFreq(val) {
        v.params.freq = Math.max(1, Math.min(20000, Number(val) || 0));
        freqR.value = String(Math.min(2000, Math.max(20, v.params.freq)));
        freqN.value = String(Math.round(v.params.freq));
        syncInfo();
        if (ac) {
          v.osc.frequency.setValueAtTime(v.params.freq, now());
        }
      }

      freqR.addEventListener("input", () => setFreq(freqR.value));
      freqN.addEventListener("change", () => setFreq(freqN.value));
      a4Btn.addEventListener("click", () => setFreq(440));

      lvlR.addEventListener("input", () => {
        v.params.level = Number(lvlR.value);
        syncInfo();
        refreshAllEnvelopes();
      });

      detR.addEventListener("input", () => {
        v.params.detune = Number(detR.value);
        syncInfo();
        if (ac) v.osc.detune.setValueAtTime(v.params.detune + state.globalDetune, now());
      });

      panR.addEventListener("input", () => {
        v.params.pan = Number(panR.value);
        syncInfo();
        if (ac) v.panner.pan.setValueAtTime(v.params.pan, now());
      });

      trigBtn.addEventListener("click", () => {
        v.params.on = true;
        syncInfo();
        if (!ac) return;
        applyVoiceParams(v);
        envOn(v);
        refreshAllEnvelopes();
      });

      offBtn.addEventListener("click", () => {
        v.params.on = false;
        syncInfo();
        if (!ac) return;
        envOff(v);
        refreshAllEnvelopes();
      });

      // initial UI state
      v.params.on = false;
      syncInfo();

      v.ui = { card };
    });
  }

  // ---------- Global UI bindings ----------
  function setADSRLabels() {
    aValEl.textContent = `${(+atkEl.value).toFixed(3)} s`;
    dValEl.textContent = `${(+decEl.value).toFixed(3)} s`;
    sValEl.textContent = `${(+susEl.value).toFixed(3)}`;
    rValEl.textContent = `${(+relEl.value).toFixed(3)} s`;
  }
  function setLimiterLabel() {
    limValEl.textContent = `${(+limiterEl.value)} dB`;
  }
  function setMasterLabel() {
    masterValEl.textContent = (+masterEl.value).toFixed(3);
  }
  function setGlobalDetuneLabel() {
    gDetValEl.textContent = `${(+gDetEl.value)|0} cents`;
  }

  atkEl.addEventListener("input", () => { state.adsr.a = +atkEl.value; setADSRLabels(); refreshAllEnvelopes(); });
  decEl.addEventListener("input", () => { state.adsr.d = +decEl.value; setADSRLabels(); refreshAllEnvelopes(); });
  susEl.addEventListener("input", () => { state.adsr.s = +susEl.value; setADSRLabels(); refreshAllEnvelopes(); });
  relEl.addEventListener("input", () => { state.adsr.r = +relEl.value; setADSRLabels(); /* release affects off */ });

  masterEl.addEventListener("input", () => {
    setMasterLabel();
    if (masterGain) masterGain.gain.setValueAtTime(+masterEl.value, now());
  });

  limiterEl.addEventListener("input", () => {
    setLimiterLabel();
    if (compressor) compressor.threshold.setValueAtTime(+limiterEl.value, now());
  });

  gDetEl.addEventListener("input", () => {
    state.globalDetune = +gDetEl.value;
    setGlobalDetuneLabel();
    if (ac) {
      voices.forEach(v => v.osc.detune.setValueAtTime(v.params.detune + state.globalDetune, now()));
    }
  });

  btnStart.addEventListener("click", async () => {
    ensureAudio();
    if (ac.state === "suspended") await ac.resume();
    state.running = true;
    statusEl.textContent = "RUN";
    btnStart.disabled = true;
    btnStop.disabled = false;
    startScope();
  });

  btnStop.addEventListener("click", async () => {
    if (!ac) return;
    // Fade out smoothly then suspend
    const t = now();
    masterGain.gain.cancelScheduledValues(t);
    masterGain.gain.setValueAtTime(masterGain.gain.value, t);
    masterGain.gain.linearRampToValueAtTime(0.0, t + 0.05);

    voices.forEach(v => envOff(v));

    setTimeout(async () => {
      try { await ac.suspend(); } catch {}
      masterGain.gain.setValueAtTime(+masterEl.value, now());
      state.running = false;
      statusEl.textContent = "STOP";
      btnStart.disabled = false;
      btnStop.disabled = true;
    }, 70);
  });

  btnPanic.addEventListener("click", () => {
    if (!ac) return;
    const t = now();
    voices.forEach(v => {
      v.params.on = false;
      v.params.mute = false;
      v.params.solo = false;
      v.gain.gain.cancelScheduledValues(t);
      v.gain.gain.setValueAtTime(0, t);
      // update UI chips
      const onBtn = el(`vOn_${v.idx}`);
      const muteBtn = el(`vMute_${v.idx}`);
      const soloBtn = el(`vSolo_${v.idx}`);
      if (onBtn) { onBtn.classList.remove("on"); onBtn.textContent = "OFF"; }
      if (muteBtn) muteBtn.classList.remove("on");
      if (soloBtn) soloBtn.classList.remove("on");
    });

    // Quick master dip (no clicks)
    masterGain.gain.cancelScheduledValues(t);
    masterGain.gain.setValueAtTime(masterGain.gain.value, t);
    masterGain.gain.linearRampToValueAtTime(0.0, t + 0.01);
    masterGain.gain.linearRampToValueAtTime(+masterEl.value, t + 0.08);

    updateMixInfo();
  });

  presetChord.addEventListener("click", () => {
    ensureAudio();
    // A major chord: 440 (A4), 554.37 (C#5), 659.25 (E5) + octave
    const freqs = [440, 554.37, 659.25, 880, 1108.73, 1318.51, 220, 329.63];
    voices.forEach((v,i) => {
      v.params.waveform = (i < 4) ? "sawtooth" : "triangle";
      v.params.freq = freqs[i] || 440;
      v.params.level = (i < 3) ? 0.18 : 0.10;
      v.params.detune = (i%2===0) ? -6 : 6;
      v.params.pan = (i%2===0) ? -0.35 : 0.35;
      v.params.on = i < 6;
      v.params.mute = false;
      v.params.solo = false;
      // sync UI controls values
      const waveSel = el(`vWave_${v.idx}`); if (waveSel) waveSel.value = v.params.waveform;
      const freqR = el(`vFreq_${v.idx}`); if (freqR) freqR.value = String(Math.min(2000, Math.max(20, v.params.freq)));
      const freqN = el(`vFreqNum_${v.idx}`); if (freqN) freqN.value = String(Math.round(v.params.freq));
      const lvlR = el(`vLvl_${v.idx}`); if (lvlR) lvlR.value = String(v.params.level);
      const detR = el(`vDet_${v.idx}`); if (detR) detR.value = String(v.params.detune);
      const panR = el(`vPan_${v.idx}`); if (panR) panR.value = String(v.params.pan);
      // update chips text quickly
      const onBtn = el(`vOn_${v.idx}`); if (onBtn){ onBtn.classList.toggle("on", v.params.on); onBtn.textContent = v.params.on ? "ON":"OFF"; }
      const muteBtn = el(`vMute_${v.idx}`); if (muteBtn) muteBtn.classList.toggle("on", v.params.mute);
      const soloBtn = el(`vSolo_${v.idx}`); if (soloBtn) soloBtn.classList.toggle("on", v.params.solo);
      // info labels
      const info = el(`vInfo_${v.idx}`);
      if (info) info.textContent = `freq ${Math.round(v.params.freq)} Hz ‚Ä¢ gain ${v.params.level.toFixed(2)} ‚Ä¢ pan ${v.params.pan.toFixed(2)}`;
      const waveLbl = el(`vWaveLbl_${v.idx}`); if (waveLbl) waveLbl.textContent = v.params.waveform;
      const freqLbl = el(`vFreqLbl_${v.idx}`); if (freqLbl) freqLbl.textContent = `${Math.round(v.params.freq)} Hz`;
      const lvlLbl = el(`vLvlLbl_${v.idx}`); if (lvlLbl) lvlLbl.textContent = v.params.level.toFixed(2);
      const detLbl = el(`vDetLbl_${v.idx}`); if (detLbl) detLbl.textContent = `${v.params.detune|0} cents`;
      const panLbl = el(`vPanLbl_${v.idx}`); if (panLbl) panLbl.textContent = `${v.params.pan.toFixed(2)}`;
    });

    voices.forEach(v => {
      applyVoiceParams(v);
      if (v.params.on) envOn(v); else envOff(v);
    });
    refreshAllEnvelopes();
  });

  presetHarm.addEventListener("click", () => {
    ensureAudio();
    // Harmonic series around 110 Hz (A2): 1..8 partials
    const base = 110;
    voices.forEach((v,i) => {
      const n = i+1;
      v.params.waveform = (n <= 2) ? "sine" : (n <= 5 ? "triangle" : "square");
      v.params.freq = base * n;
      v.params.level = 0.22 / n; // decreasing
      v.params.detune = 0;
      v.params.pan = (i%2===0) ? -0.25 : 0.25;
      v.params.on = true;
      v.params.mute = false;
      v.params.solo = false;

      const waveSel = el(`vWave_${v.idx}`); if (waveSel) waveSel.value = v.params.waveform;
      const freqR = el(`vFreq_${v.idx}`); if (freqR) freqR.value = String(Math.min(2000, Math.max(20, v.params.freq)));
      const freqN = el(`vFreqNum_${v.idx}`); if (freqN) freqN.value = String(Math.round(v.params.freq));
      const lvlR = el(`vLvl_${v.idx}`); if (lvlR) lvlR.value = String(v.params.level);
      const detR = el(`vDet_${v.idx}`); if (detR) detR.value = String(v.params.detune);
      const panR = el(`vPan_${v.idx}`); if (panR) panR.value = String(v.params.pan);

      const onBtn = el(`vOn_${v.idx}`); if (onBtn){ onBtn.classList.toggle("on", v.params.on); onBtn.textContent="ON"; }
      const muteBtn = el(`vMute_${v.idx}`); if (muteBtn) muteBtn.classList.toggle("on", v.params.mute);
      const soloBtn = el(`vSolo_${v.idx}`); if (soloBtn) soloBtn.classList.toggle("on", v.params.solo);

      const info = el(`vInfo_${v.idx}`);
      if (info) info.textContent = `freq ${Math.round(v.params.freq)} Hz ‚Ä¢ gain ${v.params.level.toFixed(2)} ‚Ä¢ pan ${v.params.pan.toFixed(2)}`;
      const waveLbl = el(`vWaveLbl_${v.idx}`); if (waveLbl) waveLbl.textContent = v.params.waveform;
      const freqLbl = el(`vFreqLbl_${v.idx}`); if (freqLbl) freqLbl.textContent = `${Math.round(v.params.freq)} Hz`;
      const lvlLbl = el(`vLvlLbl_${v.idx}`); if (lvlLbl) lvlLbl.textContent = v.params.level.toFixed(2);
      const detLbl = el(`vDetLbl_${v.idx}`); if (detLbl) detLbl.textContent = `${v.params.detune|0} cents`;
      const panLbl = el(`vPanLbl_${v.idx}`); if (panLbl) panLbl.textContent = `${v.params.pan.toFixed(2)}`;
    });

    voices.forEach(v => {
      applyVoiceParams(v);
      envOn(v);
    });
    refreshAllEnvelopes();
  });

  function updateMixInfo() {
    // Rough estimate: sum of target gains (pre ADSR sustain), not accounting for phase
    const anySolo = voices.some(v => v.params.solo);
    let sum = 0;
    let active = 0;
    voices.forEach(v => {
      const pass = (!anySolo || v.params.solo) && v.params.on && !v.params.mute;
      if (pass) { sum += v.params.level; active++; }
    });
    const estPeak = sum; // simplistic
    mixInfoEl.textContent = `${active}/${MAX_VOICES} active ‚Ä¢ estPeak ${estPeak.toFixed(2)}`;
  }

  // ---------- Oscilloscope ----------
  let raf = 0;
  let lastFpsT = 0;
  let frames = 0;

  function drawScope() {
    raf = requestAnimationFrame(drawScope);
    if (!analyser) return;

    const w = canvas.width;
    const h = canvas.height;

    const data = new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(data);

    // background
    ctx2d.clearRect(0,0,w,h);
    ctx2d.fillStyle = "rgba(0,0,0,0.25)";
    ctx2d.fillRect(0,0,w,h);

    // grid
    ctx2d.strokeStyle = "rgba(255,255,255,0.08)";
    ctx2d.lineWidth = 1;
    ctx2d.beginPath();
    for (let i=1;i<6;i++){
      const y = (h*i)/6;
      ctx2d.moveTo(0,y); ctx2d.lineTo(w,y);
    }
    for (let i=1;i<10;i++){
      const x = (w*i)/10;
      ctx2d.moveTo(x,0); ctx2d.lineTo(x,h);
    }
    ctx2d.stroke();

    // waveform
    ctx2d.strokeStyle = "rgba(78,161,255,0.95)";
    ctx2d.lineWidth = 2;
    ctx2d.beginPath();
    const mid = h/2;
    for (let i=0;i<data.length;i++){
      const x = (i/(data.length-1))*w;
      const v = (data[i]-128)/128; // -1..1
      const y = mid + v*(h*0.38);
      if (i===0) ctx2d.moveTo(x,y);
      else ctx2d.lineTo(x,y);
    }
    ctx2d.stroke();

    // fps
    frames++;
    const t = performance.now();
    if (t - lastFpsT > 600) {
      const fps = frames * 1000 / (t - lastFpsT);
      fpsEl.textContent = fps.toFixed(0);
      lastFpsT = t;
      frames = 0;
    }
  }

  function startScope() {
    if (raf) cancelAnimationFrame(raf);
    lastFpsT = performance.now();
    frames = 0;
    drawScope();
  }

  // ---------- init labels ----------
  setMasterLabel();
  setLimiterLabel();
  setADSRLabels();
  setGlobalDetuneLabel();

  // Pre-build voice UI placeholders (without audio yet)
  // We'll create a lightweight placeholder list, then rebuild after audio init.
  (function buildPlaceholder(){
    voicesRoot.innerHTML = "";
    for (let i=1;i<=MAX_VOICES;i++){
      const d = document.createElement("div");
      d.className = "card voice";
      d.innerHTML = `
        <div class="voiceHead">
          <div class="left">
            <div class="badge">${i}</div>
            <div style="display:flex; flex-direction:column; gap:2px;">
              <div style="font-weight:800; letter-spacing:.2px;">Voice ${i}</div>
              <div class="small">Premi Start per inizializzare l‚Äôaudio.</div>
            </div>
          </div>
          <div class="toggles">
            <span class="pill">‚Äî</span>
          </div>
        </div>
        <div class="footerNote">La GUI completa si attiva dopo Start (policy autoplay audio).</div>
      `;
      voicesRoot.appendChild(d);
    }
  })();

})();
</script>
</body>
</html>