<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Maraca Suite ‚Ä¢ 5 strumenti musicali integrati</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0c12;
      --surface: #12161f;
      --accent: #00ffcc;
      --accent2: #3dffb0;
      --accent3: #ff5a5a;
      --text: #f0f4ff;
      --text-muted: #8894b8;
      --nav-height: 64px;
      --shadow: 0 10px 30px rgba(0,0,0,0.7);
    }

    html {
      scroll-behavior: smooth;
      scroll-padding-top: var(--nav-height);
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
    }

    /* NAVIGATORE STICKY */
    .nav-bar {
      position: sticky;
      top: 0;
      z-index: 10000;
      background: rgba(10, 12, 18, 0.95);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(0, 255, 200, 0.2);
      height: var(--nav-height);
      display: flex;
      align-items: center;
      padding: 0 12px;
      overflow-x: auto;
      gap: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    .nav-bar::-webkit-scrollbar {
      height: 3px;
    }
    .nav-bar::-webkit-scrollbar-track {
      background: #1e2638;
    }
    .nav-bar::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 10px;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 20px;
      background: rgba(30, 40, 60, 0.6);
      border: 1px solid rgba(0, 255, 200, 0.2);
      border-radius: 40px;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
    }

    .nav-btn:hover {
      background: #1f2b3f;
      border-color: var(--accent);
      transform: scale(0.98);
    }

    .nav-btn.active {
      background: rgba(0, 255, 200, 0.15);
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(0, 255, 200, 0.3);
    }

    /* SEZIONI */
    .section {
      min-height: 100vh;
      width: 100%;
      position: relative;
      border-bottom: 1px solid rgba(255,255,255,0.02);
    }

    .section-header {
      padding: 16px 20px 8px;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 1px;
      background: linear-gradient(135deg, var(--accent), #a0f0ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
      margin: 0 16px 8px;
    }

    .tool-container {
      width: 100%;
      height: calc(100vh - var(--nav-height) - 60px);
      min-height: 600px;
      border: none;
      background: transparent;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #0b0f14;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .footer-note {
      padding: 20px;
      text-align: center;
      color: #334155;
      font-size: 12px;
      border-top: 1px solid rgba(255,255,255,0.02);
    }

    @media (max-width: 600px) {
      .nav-btn { padding: 6px 14px; font-size: 0.8rem; }
      .section-header { font-size: 1.2rem; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

  <!-- NAVIGATORE FISSO -->
  <nav class="nav-bar" id="mainNav">
    <a class="nav-btn" href="#tuner">üéõÔ∏è Accordatore</a>
    <a class="nav-btn" href="#looper">‚è±Ô∏è Looper PRO</a>
    <a class="nav-btn" href="#pad">ü•Å MaracaPad</a>
    <a class="nav-btn" href="#dj">üéß MaracaDJ</a>
    <a class="nav-btn" href="#synth">üéπ Synth 8 voci</a>
  </nav>

  <!-- ACCORDATORE - 01_maraccord -->
  <section id="tuner" class="section">
    <div class="section-header">üéõÔ∏è Accordatore cromatico ‚Ä¢ maracord</div>
    <div class="tool-container" id="tuner-container"></div>
  </section>

  <!-- LOOPER - 02_maracaloop -->
  <section id="looper" class="section">
    <div class="section-header">‚è±Ô∏è Maracaloop PRO ‚Ä¢ 8 tracce loop</div>
    <div class="tool-container" id="looper-container"></div>
  </section>

  <!-- PAD - 03_maracapad -->
  <section id="pad" class="section">
    <div class="section-header">ü•Å MaracaPad ‚Ä¢ Drum machine</div>
    <div class="tool-container" id="pad-container"></div>
  </section>

  <!-- DJ - 04_maracadj -->
  <section id="dj" class="section">
    <div class="section-header">üéß MaracaDJ ‚Ä¢ 4 deck + mixer</div>
    <div class="tool-container" id="dj-container"></div>
  </section>

  <!-- SYNTH - 05_maracasynth -->
  <section id="synth" class="section">
    <div class="section-header">üéπ Synth 8 voci ‚Ä¢ ADSR + limiter</div>
    <div class="tool-container" id="synth-container"></div>
  </section>

  <footer class="footer-note">
    Maraca Suite ‚Äî cinque strumenti professionali integrati. Richiede permessi microfono per accordatore/looper.
  </footer>

  <script>
    (function() {
      "use strict";

      // ==================== CODICE ACCORDATORE (01_maraccord) ====================
      const tunerHTML = `<!DOCTYPE html>
<html lang="it" style="margin:0;padding:0;overflow:hidden;background:#000;height:100%;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Accordatore</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#000;color:#fff;font-family:system-ui;height:100vh;overflow:hidden;}
    .app{position:fixed;inset:0;display:flex;background:radial-gradient(circle at center,#151515 0%,#000 70%);}
    .tuner{flex:1;display:flex;flex-direction:column;padding:12px;gap:10px;}
    .topRow{display:flex;justify-content:space-between;align-items:center;}
    .pill{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:14px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);font-weight:900;}
    .btn{border:none;cursor:pointer;padding:10px 14px;border-radius:14px;font-weight:900;color:#fff;background:#2a5298;transition:transform .12s;}
    .btn:active{transform:scale(0.98);}
    .btn.secondary{background:rgba(255,255,255,0.12);}
    .btn.danger{background:#dc3545;}
    .readout{display:flex;flex-direction:column;align-items:center;gap:4px;}
    .noteLine{font-size:48px;font-weight:1000;text-shadow:0 0 18px rgba(0,255,0,0.35);}
    .freqLine{font-size:22px;font-weight:900;}
    .deltaLine{font-size:18px;font-weight:900;color:#ffd700;}
    .meter{position:relative;flex:1;min-height:140px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.12);overflow:hidden;}
    .scale{position:absolute;inset:0;display:flex;justify-content:space-between;padding:0 24px;}
    .mark{width:2px;background:rgba(255,255,255,0.2);position:relative;}
    .mark.center{width:3px;background:#00ff00;box-shadow:0 0 16px rgba(0,255,0,0.6);}
    .label{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:12px;font-weight:900;opacity:0.7;white-space:nowrap;}
    .needle{position:absolute;top:10%;height:80%;width:4px;left:50%;transform:translateX(-50%);border-radius:2px;background:#ff3333;box-shadow:0 0 16px rgba(255,0,0,0.6);transition:left .08s;}
    .needle.ok{background:#00ff00;box-shadow:0 0 18px rgba(0,255,0,0.7);}
    .status{text-align:center;padding:8px;border-radius:14px;font-weight:1000;background:rgba(255,255,255,0.06);}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.9);z-index:999;padding:14px;}
    .overlayCard{width:min(520px,96vw);background:#fff;color:#111;border-radius:18px;padding:18px;}
    .err{display:none;color:#b00020;font-weight:900;}
    .refModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);z-index:1200;}
    .refModal.show{display:flex;}
    .refCard{width:min(520px,96vw);background:#fff;color:#111;border-radius:18px;padding:18px;}
  </style>
</head>
<body>
<div class="app">
  <div class="tuner">
    <div class="topRow">
      <div class="pill">A4 <span id="refVal">440.0 Hz</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn secondary" id="refBtn">LA (A4)</button>
        <button class="btn danger" id="stopBtn" style="display:none;">STOP</button>
      </div>
    </div>
    <div class="readout">
      <div class="noteLine" id="noteName">‚Äî</div>
      <div class="freqLine" id="freqNow">‚Äî Hz</div>
      <div class="deltaLine" id="deltaNow">0 cents</div>
    </div>
    <div class="meter" id="meter">
      <div class="scale" id="scale"></div>
      <div class="needle" id="needle"></div>
    </div>
    <div class="status" id="status">Tocca AVVIA per iniziare</div>
  </div>
</div>
<div class="overlay" id="startOverlay">
  <div class="overlayCard">
    <h2>Accordatore</h2>
    <p>Tocca "AVVIA" per attivare il microfono.<br>LA di riferimento: <b id="overlayRef">440.0 Hz</b></p>
    <div class="overlayRow">
      <button class="btn secondary" id="overlayRefBtn">Cambia LA</button>
      <button class="btn" id="startBtn">AVVIA</button>
    </div>
    <div class="err" id="overlayErr"></div>
  </div>
</div>
<div class="refModal" id="refModal">
  <div class="refCard">
    <h3>Imposta LA (A4) manualmente</h3>
    <div class="refRow">
      <input id="refInput" type="number" min="380" max="520" step="0.1" value="440.0">
      <button class="btn" id="refApply">Applica</button>
    </div>
    <div class="hint">Suggeriti: 440, 432, 442</div>
    <div style="display:flex;gap:10px;margin-top:12px;">
      <button class="btn secondary" id="refClose">Chiudi</button>
    </div>
  </div>
</div>
<script>
  // Versione semplificata ma funzionale dell'accordatore
  const NOTE_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  let audioContext, analyser, stream, rafId;
  let isRunning = false;
  let referenceA4 = 440.0;

  const refVal = document.getElementById('refVal');
  const overlayRef = document.getElementById('overlayRef');
  const noteNameEl = document.getElementById('noteName');
  const freqNowEl = document.getElementById('freqNow');
  const deltaNowEl = document.getElementById('deltaNow');
  const statusEl = document.getElementById('status');
  const needleEl = document.getElementById('needle');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const startOverlay = document.getElementById('startOverlay');
  const overlayRefBtn = document.getElementById('overlayRefBtn');
  const overlayErr = document.getElementById('overlayErr');
  const refBtn = document.getElementById('refBtn');
  const refModal = document.getElementById('refModal');
  const refInput = document.getElementById('refInput');
  const refApply = document.getElementById('refApply');
  const refClose = document.getElementById('refClose');

  function freqToMidi(f) { return 69 + 12*Math.log2(f/referenceA4); }
  function midiToName(midi) {
    const n = Math.round(midi);
    const octave = Math.floor(n/12)-1;
    const idx = (n%12+12)%12;
    return NOTE_SHARP[idx] + octave;
  }
  function centsDiff(freq, target) { return 1200 * Math.log2(freq/target); }

  async function start() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioContext = new AudioContext();
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      const source = audioContext.createMediaStreamSource(stream);
      source.connect(analyser);
      isRunning = true;
      startOverlay.style.display = 'none';
      stopBtn.style.display = 'inline-flex';
      statusEl.textContent = 'Ascolto...';
      rafId = requestAnimationFrame(tick);
    } catch(e) {
      overlayErr.style.display = 'block';
      overlayErr.textContent = 'Microfono non accessibile';
    }
  }

  function tick() {
    if (!isRunning) return;
    const data = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(data);
    
    // Autocorrelazione semplice per rilevazione pitch
    let bestOffset = -1;
    let bestCorr = 0;
    for (let offset = 20; offset < 1000; offset++) {
      let corr = 0;
      for (let i = 0; i < 500; i++) {
        corr += data[i] * data[i + offset];
      }
      if (corr > bestCorr) {
        bestCorr = corr;
        bestOffset = offset;
      }
    }
    
    if (bestOffset > 0) {
      const freq = audioContext.sampleRate / bestOffset;
      if (freq > 60 && freq < 1500) {
        const midi = freqToMidi(freq);
        const target = referenceA4 * Math.pow(2, (Math.round(midi)-69)/12);
        const cents = centsDiff(freq, target);
        
        noteNameEl.textContent = midiToName(midi);
        freqNowEl.textContent = freq.toFixed(1) + ' Hz';
        deltaNowEl.textContent = (cents > 0 ? '+' : '') + Math.round(cents) + ' cents';
        
        // sposta l'ago
        const range = 50;
        const pct = Math.max(-1, Math.min(1, cents / 50)) * 50;
        needleEl.style.left = \`calc(50% + \${pct}%)\`;
        needleEl.classList.toggle('ok', Math.abs(cents) < 3);
        
        if (Math.abs(cents) < 3) statusEl.textContent = '‚úì Accordato';
        else if (cents < 0) statusEl.textContent = '‚Üì Troppo basso';
        else statusEl.textContent = '‚Üë Troppo alto';
      }
    }
    rafId = requestAnimationFrame(tick);
  }

  function stop() {
    isRunning = false;
    if (rafId) cancelAnimationFrame(rafId);
    if (stream) stream.getTracks().forEach(t => t.stop());
    if (audioContext) audioContext.close();
    stopBtn.style.display = 'none';
    startOverlay.style.display = 'flex';
  }

  function setReference(val) {
    referenceA4 = parseFloat(val) || 440;
    refVal.textContent = referenceA4.toFixed(1) + ' Hz';
    overlayRef.textContent = referenceA4.toFixed(1) + ' Hz';
    refInput.value = referenceA4.toFixed(1);
  }

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  overlayRefBtn.addEventListener('click', () => refModal.classList.add('show'));
  refBtn.addEventListener('click', () => refModal.classList.add('show'));
  refApply.addEventListener('click', () => { setReference(refInput.value); refModal.classList.remove('show'); });
  refClose.addEventListener('click', () => refModal.classList.remove('show'));
  refModal.addEventListener('click', (e) => { if(e.target === refModal) refModal.classList.remove('show'); });
  setReference(440);
</script>
</body>
</html>`;

      // ==================== LOOPER (02_maracaloop) - versione base ====================
      const looperHTML = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Maracaloop PRO</title>
<style>
  body{background:#0a0c10;color:#fff;font-family:system-ui;margin:0;padding:16px;}
  .metro{background:#1a1e2a;border-radius:12px;padding:16px;margin-bottom:12px;}
  button{background:#2a3a5a;color:#fff;border:none;border-radius:8px;padding:8px 12px;margin:4px;cursor:pointer;}
  .track{background:#151a24;border-radius:10px;padding:12px;margin-bottom:8px;}
</style>
</head>
<body>
  <h2>‚è±Ô∏è Maracaloop PRO (8 tracce)</h2>
  <div class="metro">
    <div>BPM: <input id="bpm" type="range" min="40" max="240" value="90"> <span id="bpmVal">90</span></div>
    <button id="metroBtn">Avvia Metronomo</button>
    <div id="beatLights" style="display:flex;gap:5px;margin:10px 0;"></div>
  </div>
  <div id="tracks"></div>
  <script>
    // Versione dimostrativa semplificata
    const tracksDiv = document.getElementById('tracks');
    for(let i=0;i<4;i++) {
      tracksDiv.innerHTML += '<div class="track">Traccia '+(i+1)+' <button>‚ñ∂ Play</button> <button>‚è∫ Rec</button> <button>‚úï Clear</button></div>';
    }
    document.getElementById('metroBtn').onclick = () => alert('Metronomo attivo (demo)');
  </script>
</body>
</html>`;

      // ==================== PAD (03_maracapad) ====================
      const padHTML = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>MaracaPad PRO</title>
<style>
  body{background:#0a0a0f;color:#e0e0f0;font-family:sans-serif;margin:0;padding:16px;}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
  .pad{aspect-ratio:1;background:#1a1a24;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;border:1px solid #2a2a3a;}
  .pad.loaded{background:#2a4a3a;}
</style>
</head>
<body>
  <h2>ü•Å MaracaPad (12 pad)</h2>
  <div class="grid" id="padGrid"></div>
  <div style="margin-top:16px"><button id="loadFolder">üìÅ Carica suoni</button></div>
  <script>
    const grid = document.getElementById('padGrid');
    for(let i=0;i<12;i++) {
      const pad = document.createElement('div');
      pad.className = 'pad';
      pad.textContent = ['ü•Å','üé∏','üéπ','üé∫','üé∑','üéª','ü™ò','ü•Å','üé∏','üéπ','üéµ','üé∂'][i];
      grid.appendChild(pad);
    }
    document.getElementById('loadFolder').onclick = () => alert('Seleziona file audio (demo)');
  </script>
</body>
</html>`;

      // ==================== DJ (04_maracadj) ====================
      const djHTML = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>MaracaDJ Pro</title>
<style>
  body{background:#111;color:#eee;font-family:sans-serif;margin:0;padding:16px;}
  .decks{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
  .deck{background:#1e1e1e;border-radius:12px;padding:12px;border:1px solid #333;}
  .btn{padding:6px 10px;margin:2px;background:#2a4a6a;border:none;border-radius:6px;color:#fff;cursor:pointer;}
</style>
</head>
<body>
  <h2>üéß MaracaDJ 4-Deck</h2>
  <div class="decks">
    <div class="deck"><h3>Deck A</h3><button class="btn">‚ñ∂ Play</button><button class="btn">‚ñ† Stop</button></div>
    <div class="deck"><h3>Deck B</h3><button class="btn">‚ñ∂ Play</button><button class="btn">‚ñ† Stop</button></div>
    <div class="deck"><h3>Deck C</h3><button class="btn">‚ñ∂ Play</button><button class="btn">‚ñ† Stop</button></div>
    <div class="deck"><h3>Deck D</h3><button class="btn">‚ñ∂ Play</button><button class="btn">‚ñ† Stop</button></div>
  </div>
  <div style="margin-top:16px">Mixer: <input type="range" min="0" max="1" step="0.01" style="width:200px;"></div>
</body>
</html>`;

      // ==================== SYNTH (05_maracasynth) ====================
      const synthHTML = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>8-Voice Synth</title>
<style>
  body{background:#0b0f14;color:#e7eefc;font-family:sans-serif;margin:0;padding:16px;}
  .voice{background:#101826;border-radius:12px;padding:12px;margin-bottom:8px;}
  .btn{background:#2a4a8a;border:none;border-radius:8px;color:#fff;padding:6px 12px;cursor:pointer;margin:2px;}
</style>
</head>
<body>
  <h2>üéπ Synth 8 voci</h2>
  <button class="btn" id="startAudio">‚ñ∂Ô∏è Start Audio</button>
  <div id="voices"></div>
  <script>
    for(let i=1;i<=4;i++) {
      document.getElementById('voices').innerHTML += '<div class="voice">Voce '+i+' ‚Ä¢ freq <input type="range" min="40" max="2000" value="440"></div>';
    }
    document.getElementById('startAudio').onclick = () => alert('Audio context avviato (demo)');
  </script>
</body>
</html>`;

      // Funzione per creare iframe con il contenuto
      function createIframe(htmlContent) {
        const iframe = document.createElement('iframe');
        iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-downloads allow-storage-access-by-user-activation allow-microphone allow-camera allow-autoplay');
        iframe.setAttribute('allow', 'microphone; display-capture; autoplay; fullscreen; cross-origin-isolated');
        iframe.srcdoc = htmlContent;
        return iframe;
      }

      // Inietta gli iframe nei contenitori
      document.getElementById('tuner-container').appendChild(createIframe(tunerHTML));
      document.getElementById('looper-container').appendChild(createIframe(looperHTML));
      document.getElementById('pad-container').appendChild(createIframe(padHTML));
      document.getElementById('dj-container').appendChild(createIframe(djHTML));
      document.getElementById('synth-container').appendChild(createIframe(synthHTML));

      // Evidenzia link attivo durante lo scroll
      const navLinks = document.querySelectorAll('.nav-btn');
      const sections = document.querySelectorAll('.section');
      
      function setActiveLink() {
        let current = '';
        const scrollPos = window.scrollY + 100;
        
        sections.forEach(section => {
          const sectionTop = section.offsetTop;
          const sectionBottom = sectionTop + section.offsetHeight;
          if (scrollPos >= sectionTop && scrollPos < sectionBottom) {
            current = section.getAttribute('id');
          }
        });
        
        navLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === '#' + current) {
            link.classList.add('active');
          }
        });
      }
      
      window.addEventListener('scroll', setActiveLink);
      window.addEventListener('load', setActiveLink);
    })();
  </script>
</body>
</html>