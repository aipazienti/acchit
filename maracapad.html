<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>MaracaPad PRO</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #111118;
  --surface2: #1a1a24;
  --border: #2a2a3a;
  --accent: #00f5a0;
  --accent2: #00c8f5;
  --danger: #f53060;
  --warn: #f5a800;
  --text: #e0e0f0;
  --muted: #5a5a7a;
  --glow: 0 0 20px rgba(0,245,160,0.4);
  --glow2: 0 0 20px rgba(0,200,245,0.4);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: 
    radial-gradient(ellipse 60% 40% at 20% 10%, rgba(0,245,160,0.05) 0%, transparent 60%),
    radial-gradient(ellipse 50% 50% at 80% 90%, rgba(0,200,245,0.05) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

.app {
  position: relative;
  z-index: 1;
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px;
}

/* ===== HEADER ===== */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0 20px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}

.logo {
  font-family: 'Orbitron', sans-serif;
  font-weight: 900;
  font-size: clamp(18px, 4vw, 28px);
  letter-spacing: 2px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: none;
  line-height: 1.1;
}

.logo span {
  display: block;
  font-size: 0.4em;
  letter-spacing: 4px;
  font-weight: 400;
  background: none;
  -webkit-text-fill-color: var(--muted);
  color: var(--muted);
  margin-top: 2px;
}

.load-btn {
  background: transparent;
  border: 1px solid var(--accent2);
  color: var(--accent2);
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 12px;
  font-family: 'Orbitron', sans-serif;
  cursor: pointer;
  letter-spacing: 1px;
  transition: all 0.2s;
}
.load-btn:hover { background: rgba(0,200,245,0.1); box-shadow: var(--glow2); }
.load-btn:active { transform: scale(0.97); }

/* ===== TRANSPORT BAR ===== */
.transport {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.ctrl-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.ctrl-label {
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--muted);
  font-family: 'Orbitron', sans-serif;
  text-transform: uppercase;
}

/* BPM */
.bpm-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}

.bpm-input {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--accent);
  font-family: 'Orbitron', sans-serif;
  font-size: 26px;
  font-weight: 700;
  width: 76px;
  text-align: center;
  border-radius: 8px;
  padding: 6px 4px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.bpm-input:focus { border-color: var(--accent); box-shadow: var(--glow); }
.bpm-input::-webkit-inner-spin-button { -webkit-appearance: none; }

.bpm-slider {
  width: clamp(80px, 15vw, 160px);
  accent-color: var(--accent);
  cursor: pointer;
}

.bpm-arrows { display: flex; flex-direction: column; gap: 2px; }
.bpm-arrows button {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  width: 26px;
  height: 22px;
  font-size: 11px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex; align-items: center; justify-content: center;
}
.bpm-arrows button:hover { background: var(--accent); color: #000; }
.bpm-arrows button:active { transform: scale(0.9); }

/* Time Sig */
.time-select {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: 8px;
  font-family: 'Orbitron', sans-serif;
  font-size: 14px;
  outline: none;
  cursor: pointer;
  transition: border-color 0.2s;
}
.time-select:focus { border-color: var(--accent); }

/* Play/Stop */
.play-btn {
  padding: 10px 28px;
  font-family: 'Orbitron', sans-serif;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 2px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 100px;
}

.play-btn.play {
  background: linear-gradient(135deg, var(--accent), #00c890);
  color: #000;
  box-shadow: 0 4px 20px rgba(0,245,160,0.3);
}
.play-btn.play:hover { box-shadow: 0 4px 30px rgba(0,245,160,0.6); transform: translateY(-1px); }

.play-btn.stop {
  background: linear-gradient(135deg, var(--danger), #c0103a);
  color: #fff;
  box-shadow: 0 4px 20px rgba(245,48,96,0.3);
}
.play-btn.stop:hover { box-shadow: 0 4px 30px rgba(245,48,96,0.6); transform: translateY(-1px); }
.play-btn:active { transform: scale(0.96) !important; }

/* Tap Tempo */
.tap-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--muted);
  padding: 10px 16px;
  border-radius: 8px;
  font-family: 'Orbitron', sans-serif;
  font-size: 11px;
  letter-spacing: 1px;
  cursor: pointer;
  transition: all 0.15s;
}
.tap-btn:hover { border-color: var(--warn); color: var(--warn); }
.tap-btn.tapped { border-color: var(--warn); color: var(--warn); box-shadow: 0 0 12px rgba(245,168,0,0.4); }
.tap-btn:active { transform: scale(0.94); }

/* ===== BEAT LIGHTS ===== */
.beat-section {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
}

.beat-label {
  font-family: 'Orbitron', sans-serif;
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--muted);
  white-space: nowrap;
}

#beat-lights {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.beat-dot {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--surface2);
  border: 2px solid var(--border);
  transition: all 0.06s linear;
}

.beat-dot.accent {
  border-color: var(--danger);
  background: rgba(245,48,96,0.15);
}

.beat-dot.active {
  background: var(--accent);
  border-color: var(--accent);
  box-shadow: 0 0 16px var(--accent), 0 0 30px rgba(0,245,160,0.5);
  transform: scale(1.3);
}

.beat-dot.accent.active {
  background: var(--danger);
  border-color: var(--danger);
  box-shadow: 0 0 16px var(--danger), 0 0 30px rgba(245,48,96,0.5);
}

/* Bar counter */
.bar-counter {
  margin-left: auto;
  font-family: 'Orbitron', sans-serif;
  font-size: 11px;
  color: var(--muted);
  white-space: nowrap;
}
.bar-counter span {
  color: var(--accent2);
  font-size: 15px;
  font-weight: 700;
}

/* ===== PADS GRID ===== */
#pads-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}

@media (max-width: 700px) {
  #pads-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .transport { padding: 12px; gap: 10px; }
}

@media (max-width: 480px) {
  #pads-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
}

/* ===== PAD ===== */
.pad-wrap {
  position: relative;
  border-radius: 14px;
  overflow: hidden;
  background: var(--surface);
  border: 2px solid var(--border);
  transition: border-color 0.2s, transform 0.1s;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
}

.pad-wrap:hover { border-color: rgba(255,255,255,0.2); }
.pad-wrap.loaded { border-color: var(--accent) !important; }
.pad-wrap.playing { 
  transform: scale(0.94);
  box-shadow: 0 0 40px var(--pad-color, var(--accent)), inset 0 0 20px rgba(255,255,255,0.15);
}
.pad-wrap.playing .pad-face { filter: brightness(1.3); }

.pad-face {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 8px;
  position: relative;
  transition: filter 0.1s;
}

.pad-bg {
  position: absolute;
  inset: 0;
  opacity: 0.18;
  transition: opacity 0.1s;
}

.pad-wrap.playing .pad-bg { opacity: 0.4; }

.pad-number {
  font-family: 'Orbitron', sans-serif;
  font-size: clamp(8px, 1.8vw, 13px);
  font-weight: 900;
  letter-spacing: 1px;
  color: rgba(255,255,255,0.5);
  position: absolute;
  top: 6px;
  left: 8px;
}

.pad-icon {
  font-size: clamp(22px, 4vw, 36px);
  margin-bottom: 4px;
  pointer-events: none;
  position: relative;
  z-index: 1;
}

.pad-name {
  font-size: clamp(7px, 1.2vw, 10px);
  text-align: center;
  color: rgba(255,255,255,0.75);
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 0 6px;
  position: relative;
  z-index: 1;
  letter-spacing: 0.5px;
}

/* ===== PAD CONTROLS (bottom strip) ===== */
.pad-controls {
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 5px 6px;
  border-top: 1px solid rgba(255,255,255,0.08);
  flex-wrap: nowrap;
  overflow: hidden;
}

.pad-ctrl-btn {
  flex: 1;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.12);
  color: rgba(255,255,255,0.6);
  padding: 3px 0;
  border-radius: 4px;
  font-size: clamp(7px, 1.1vw, 9px);
  font-family: 'Orbitron', sans-serif;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
}
.pad-ctrl-btn:hover { background: rgba(255,255,255,0.14); color: #fff; }
.pad-ctrl-btn:active { transform: scale(0.92); }

.pad-ctrl-btn.beat-on {
  background: rgba(0,245,160,0.2);
  border-color: var(--accent);
  color: var(--accent);
  box-shadow: 0 0 8px rgba(0,245,160,0.3);
}

/* ===== VOLUME indicator on pad ===== */
.pad-vol {
  position: absolute;
  bottom: 34px;
  right: 5px;
  display: flex;
  flex-direction: column-reverse;
  gap: 1px;
  z-index: 2;
}
.vol-bar { width: 3px; height: 3px; border-radius: 1px; background: rgba(255,255,255,0.2); }
.vol-bar.active { background: var(--accent); }

/* Beat beat indicator in corner */
.beat-indicator {
  position: absolute;
  top: 5px;
  right: 6px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
  display: none;
  box-shadow: 0 0 8px var(--accent);
  z-index: 3;
  animation: pulse 1s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
.pad-wrap.beat-active .beat-indicator { display: block; }

/* ===== TIMING SELECTOR popup ===== */
.pad-timing-label {
  font-size: clamp(7px, 1.1vw, 9px);
  font-family: 'Orbitron', sans-serif;
  color: rgba(255,255,255,0.5);
  white-space: nowrap;
}

/* ===== STATUS BAR ===== */
.status-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 14px;
  padding: 10px 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 10px;
  color: var(--muted);
  letter-spacing: 1px;
  flex-wrap: wrap;
  gap: 8px;
}

.status-bar .tag {
  background: rgba(0,245,160,0.1);
  border: 1px solid rgba(0,245,160,0.3);
  color: var(--accent);
  padding: 3px 8px;
  border-radius: 4px;
  font-family: 'Orbitron', sans-serif;
  font-size: 9px;
}

/* ===== RUNNING indicator ===== */
.running-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--muted);
  display: inline-block;
  margin-right: 4px;
  vertical-align: middle;
  transition: background 0.2s, box-shadow 0.2s;
}
.running-dot.on { background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: pulse 0.8s infinite; }

/* ===== TOOLTIPS / HINT ===== */
.hint-row {
  text-align: center;
  font-size: 10px;
  color: var(--muted);
  letter-spacing: 1px;
  padding: 6px 0 2px;
}

/* ===== VOLUME SLIDER on pad (hidden by default) ===== */
.pad-vol-slider {
  display: none;
  width: 100%;
  accent-color: var(--accent);
  margin-top: 2px;
}
.pad-wrap.expanded .pad-vol-slider { display: block; }

/* Scrollbar style */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo">
      MARACAPAD
      <span>PRO DRUM MACHINE</span>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <button class="load-btn" onclick="loadFolder()">üìÅ CARICA CARTELLA</button>
      <button class="load-btn" onclick="clearAll()" style="border-color:var(--danger);color:var(--danger);">‚úï CLEAR</button>
    </div>
  </header>

  <!-- TRANSPORT -->
  <div class="transport">

    <!-- PLAY/STOP -->
    <div style="display:flex;gap:8px;">
      <button id="play-btn" class="play-btn play" onclick="togglePlay()">‚ñ∂ PLAY</button>
    </div>

    <!-- BPM -->
    <div class="ctrl-group">
      <div class="ctrl-label">BPM</div>
      <div class="bpm-wrap">
        <div class="bpm-arrows">
          <button onclick="changeBPM(1)">‚ñ≤</button>
          <button onclick="changeBPM(-1)">‚ñº</button>
        </div>
        <input id="bpm-input" class="bpm-input" type="number" min="30" max="300" value="90" 
               oninput="setBPMFromInput()" onblur="clampBPM()" onkeydown="bpmKey(event)">
        <input id="bpm-slider" class="bpm-slider" type="range" min="30" max="300" value="90" 
               oninput="setBPMFromSlider()">
        <button class="tap-btn" id="tap-btn" onclick="tapTempo()">TAP</button>
      </div>
    </div>

    <!-- TIME SIG -->
    <div class="ctrl-group">
      <div class="ctrl-label">BATTUTE</div>
      <select class="time-select" id="time-sig" onchange="changeTimeSig()">
        <option value="2">2/4</option>
        <option value="3">3/4</option>
        <option value="4" selected>4/4</option>
        <option value="5">5/4</option>
        <option value="6">6/8</option>
        <option value="7">7/8</option>
        <option value="8">8/8</option>
      </select>
    </div>

    <!-- SWING -->
    <div class="ctrl-group">
      <div class="ctrl-label">SWING</div>
      <select class="time-select" id="swing-select" onchange="updateSwing()">
        <option value="0">NESSUNO</option>
        <option value="0.1">LEGGERO</option>
        <option value="0.2">MEDIO</option>
        <option value="0.35">FORTE</option>
      </select>
    </div>

  </div>

  <!-- BEAT LIGHTS -->
  <div class="beat-section">
    <div class="beat-label">BEAT</div>
    <div id="beat-lights"></div>
    <div class="bar-counter">MISURA <span id="bar-count">1</span></div>
  </div>

  <div class="hint-row">CLICK SUL PAD = SUONA ‚Ä¢ ‚ñ∏BEAT = LOOP AUTO ‚Ä¢ ¬Ω = DIMEZZA BEAT ‚Ä¢ √ó2 = RADDOPPIA BEAT</div>

  <!-- PADS -->
  <div id="pads-grid"></div>

  <!-- STATUS -->
  <div class="status-bar">
    <div>
      <span class="running-dot" id="run-dot"></span>
      <span id="status-text">FERMO</span>
    </div>
    <div>
      <span class="tag" id="bpm-tag">90 BPM</span>
    </div>
    <div style="color:var(--muted);font-size:9px;letter-spacing:0.5px;">
      Chrome/Edge per caricamento cartella ‚Ä¢ Tutti i formati audio
    </div>
  </div>

</div>

<script>
// ====================== STATO ======================
let bpm = 90;
let beatsPerBar = 4;
let isRunning = false;
let currentBeat = 0;
let barCount = 1;
let schedulerInterval = null;
let swingAmount = 0;
let tapTimes = [];

const pads = [];

const PAD_COLORS = [
  '#f55560','#f5803a','#f5c840','#90e050',
  '#3ad4a0','#30a8f5','#5060f5','#a040e0',
  '#f550c0','#40e0d0','#f0f040','#50d080'
];

const PAD_ICONS = [
  'ü•Å','üé∏','üéπ','üé∫','üé∑','üéª','ü™ò','ü•Å',
  'üé∏','üéπ','üéµ','üé∂'
];

let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

// ====================== INIT ======================
function init() {
  buildPads();
  buildBeatLights();
  updateBpmDisplay();
}

// ====================== PADS ======================
function buildPads() {
  const grid = document.getElementById('pads-grid');
  grid.innerHTML = '';

  for (let i = 0; i < 12; i++) {
    const pad = {
      index: i,
      buffer: null,
      name: '',
      triggerOnBeat: false,
      beatDiv: 1,        // 1=ogni beat, 2=ogni 2 beat (dimezza), 0.5=ogni mezzo beat (raddoppia)
      volume: 1,
      color: PAD_COLORS[i],
      el: null,
      nameEl: null,
      beatBtn: null,
      halfBtn: null,
      doubleBtn: null,
      beatDivLabel: null,
      beatIndicator: null
    };
    pads.push(pad);

    const wrap = document.createElement('div');
    wrap.className = 'pad-wrap';
    wrap.style.setProperty('--pad-color', pad.color);

    // Background color
    const bg = document.createElement('div');
    bg.className = 'pad-bg';
    bg.style.background = `radial-gradient(circle at 50% 40%, ${pad.color}, transparent 70%)`;

    // Pad face
    const face = document.createElement('div');
    face.className = 'pad-face';

    const num = document.createElement('div');
    num.className = 'pad-number';
    num.textContent = String(i+1).padStart(2,'0');

    const icon = document.createElement('div');
    icon.className = 'pad-icon';
    icon.textContent = PAD_ICONS[i];

    const name = document.createElement('div');
    name.className = 'pad-name';
    name.textContent = 'CARICA SUONO';

    // Beat active indicator dot
    const bDot = document.createElement('div');
    bDot.className = 'beat-indicator';

    // Volume bars decoration
    const volBars = document.createElement('div');
    volBars.className = 'pad-vol';
    for(let v=0;v<5;v++) {
      const vb = document.createElement('div');
      vb.className = 'vol-bar' + (v < 3 ? ' active' : '');
      volBars.appendChild(vb);
    }

    face.appendChild(bg);
    face.appendChild(num);
    face.appendChild(icon);
    face.appendChild(name);
    face.appendChild(bDot);
    face.appendChild(volBars);

    // Controls strip
    const ctrl = document.createElement('div');
    ctrl.className = 'pad-controls';

    const beatBtn = document.createElement('button');
    beatBtn.className = 'pad-ctrl-btn';
    beatBtn.textContent = '‚ñ∏BEAT';
    beatBtn.onclick = (e) => { e.stopPropagation(); toggleBeat(i); };

    const halfBtn = document.createElement('button');
    halfBtn.className = 'pad-ctrl-btn';
    halfBtn.textContent = '¬Ω';
    halfBtn.title = 'Dimezza frequenza';
    halfBtn.onclick = (e) => { e.stopPropagation(); cycleBeatDiv(i, -1); };

    const divLabel = document.createElement('button');
    divLabel.className = 'pad-ctrl-btn';
    divLabel.style.cssText = 'flex:0.8;color:rgba(255,255,255,0.8);cursor:default;';
    divLabel.textContent = '1:1';

    const doubleBtn = document.createElement('button');
    doubleBtn.className = 'pad-ctrl-btn';
    doubleBtn.textContent = '√ó2';
    doubleBtn.title = 'Raddoppia frequenza';
    doubleBtn.onclick = (e) => { e.stopPropagation(); cycleBeatDiv(i, 1); };

    ctrl.appendChild(beatBtn);
    ctrl.appendChild(halfBtn);
    ctrl.appendChild(divLabel);
    ctrl.appendChild(doubleBtn);

    wrap.appendChild(face);
    wrap.appendChild(ctrl);

    wrap.addEventListener('click', () => onPadClick(i));
    wrap.addEventListener('touchstart', (e) => { e.preventDefault(); onPadClick(i); }, {passive:false});

    grid.appendChild(wrap);

    pad.el = wrap;
    pad.nameEl = name;
    pad.beatBtn = beatBtn;
    pad.halfBtn = halfBtn;
    pad.doubleBtn = doubleBtn;
    pad.beatDivLabel = divLabel;
    pad.beatIndicator = bDot;
  }
}

// ====================== BEAT DIV CYCLE ======================
const BEAT_DIVS = [0.25, 0.5, 1, 2, 4];
const BEAT_LABELS = ['1:4','1:2','1:1','2:1','4:1'];

function cycleBeatDiv(idx, dir) {
  const pad = pads[idx];
  const curr = BEAT_DIVS.indexOf(pad.beatDiv);
  const next = Math.max(0, Math.min(BEAT_DIVS.length-1, curr + dir));
  pad.beatDiv = BEAT_DIVS[next];
  pad.beatDivLabel.textContent = BEAT_LABELS[next];
  
  // color hint
  if(next < 2) {
    pad.beatDivLabel.style.color = '#f5a800';
  } else if(next > 2) {
    pad.beatDivLabel.style.color = '#00f5a0';
  } else {
    pad.beatDivLabel.style.color = 'rgba(255,255,255,0.8)';
  }
}

// ====================== TOGGLE BEAT ======================
function toggleBeat(idx) {
  const pad = pads[idx];
  pad.triggerOnBeat = !pad.triggerOnBeat;
  if(pad.triggerOnBeat) {
    pad.beatBtn.classList.add('beat-on');
    pad.beatBtn.textContent = '‚ñ†BEAT';
    pad.el.classList.add('beat-active');
  } else {
    pad.beatBtn.classList.remove('beat-on');
    pad.beatBtn.textContent = '‚ñ∏BEAT';
    pad.el.classList.remove('beat-active');
  }
}

// ====================== PAD CLICK ======================
function onPadClick(idx) {
  const pad = pads[idx];
  if(!pad.buffer) {
    loadSingleSound(idx);
  } else {
    playPad(idx);
  }
}

// ====================== PLAY PAD ======================
function playPad(idx, when) {
  const pad = pads[idx];
  if(!pad.buffer) return;
  
  const ctx = getAudioCtx();
  const source = ctx.createBufferSource();
  source.buffer = pad.buffer;
  
  const gain = ctx.createGain();
  gain.gain.value = pad.volume;
  
  source.connect(gain);
  gain.connect(ctx.destination);
  
  if(when && when > ctx.currentTime) {
    source.start(when);
  } else {
    source.start(ctx.currentTime);
    // Visual flash
    flashPad(idx);
  }
}

function flashPad(idx) {
  const pad = pads[idx];
  pad.el.classList.add('playing');
  setTimeout(() => pad.el.classList.remove('playing'), 140);
}

// ====================== METRONOME TICK ======================
let beatStep = 0; // fractional beat counter (supports half/double)
const STEPS_PER_BEAT = 4; // resolution: 4 steps per beat
let stepCounter = 0;

function tick() {
  const step = stepCounter % (beatsPerBar * STEPS_PER_BEAT);
  const beatIndex = Math.floor(step / STEPS_PER_BEAT);
  const subStep = step % STEPS_PER_BEAT;

  // Update beat lights (only on beat boundaries)
  if(subStep === 0) {
    updateBeatLights(beatIndex);
    if(beatIndex === 0) {
      barCount++;
      document.getElementById('bar-count').textContent = barCount;
    }
  }

  // Trigger pads
  pads.forEach((pad, idx) => {
    if(!pad.triggerOnBeat || !pad.buffer) return;
    
    // beatDiv: 1=ogni beat, 2=ogni 2beat, 0.5=ogni mezzo beat, etc.
    const stepsForDiv = STEPS_PER_BEAT / pad.beatDiv;
    
    if(stepsForDiv >= 1) {
      // trigger every N steps
      if(step % Math.round(stepsForDiv) === 0) {
        playPad(idx);
        flashPad(idx);
      }
    } else {
      // multiple triggers per beat
      const triggersPerStep = 1 / stepsForDiv;
      if(subStep % (1/triggersPerStep) < 0.01) {
        playPad(idx);
        flashPad(idx);
      }
    }
  });

  stepCounter++;
}

function updateBeatLights(beatIndex) {
  const lights = document.querySelectorAll('.beat-dot');
  lights.forEach((l, i) => {
    l.classList.remove('active');
    if(i === beatIndex) l.classList.add('active');
  });
  currentBeat = beatIndex;
}

// ====================== PLAY/STOP ======================
function togglePlay() {
  if(!audioCtx) getAudioCtx();
  if(audioCtx.state === 'suspended') audioCtx.resume();
  
  if(isRunning) {
    stopMetronome();
  } else {
    startMetronome();
  }
}

function startMetronome() {
  isRunning = true;
  stepCounter = 0;
  barCount = 0;
  
  const msPerStep = (60000 / bpm) / STEPS_PER_BEAT;
  
  tick();
  schedulerInterval = setInterval(tick, msPerStep);
  
  document.getElementById('play-btn').textContent = '‚ñ† STOP';
  document.getElementById('play-btn').className = 'play-btn stop';
  document.getElementById('run-dot').classList.add('on');
  document.getElementById('status-text').textContent = 'IN RIPRODUZIONE';
}

function stopMetronome() {
  clearInterval(schedulerInterval);
  isRunning = false;
  stepCounter = 0;
  barCount = 1;
  
  document.getElementById('play-btn').textContent = '‚ñ∂ PLAY';
  document.getElementById('play-btn').className = 'play-btn play';
  document.getElementById('run-dot').classList.remove('on');
  document.getElementById('status-text').textContent = 'FERMO';
  document.getElementById('bar-count').textContent = '1';
  
  // Clear all lights
  document.querySelectorAll('.beat-dot').forEach(l => l.classList.remove('active'));
}

// ====================== BPM ======================
function updateBpmDisplay() {
  document.getElementById('bpm-input').value = bpm;
  document.getElementById('bpm-slider').value = bpm;
  document.getElementById('bpm-tag').textContent = bpm + ' BPM';
}

function setBPMFromInput() {
  const v = parseInt(document.getElementById('bpm-input').value);
  if(v >= 30 && v <= 300) { bpm = v; applyBPM(); }
}

function setBPMFromSlider() {
  bpm = parseInt(document.getElementById('bpm-slider').value);
  document.getElementById('bpm-input').value = bpm;
  applyBPM();
}

function changeBPM(delta) {
  bpm = Math.max(30, Math.min(300, bpm + delta));
  updateBpmDisplay();
  applyBPM();
}

function bpmKey(e) {
  if(e.key==='ArrowUp') { e.preventDefault(); changeBPM(1); }
  if(e.key==='ArrowDown') { e.preventDefault(); changeBPM(-1); }
}

function clampBPM() {
  const v = parseInt(document.getElementById('bpm-input').value);
  if(isNaN(v) || v < 30) { bpm = 30; }
  else if(v > 300) { bpm = 300; }
  else { bpm = v; }
  updateBpmDisplay();
  applyBPM();
}

function applyBPM() {
  document.getElementById('bpm-tag').textContent = bpm + ' BPM';
  if(isRunning) {
    clearInterval(schedulerInterval);
    const msPerStep = (60000 / bpm) / STEPS_PER_BEAT;
    schedulerInterval = setInterval(tick, msPerStep);
  }
}

// ====================== TAP TEMPO ======================
function tapTempo() {
  const now = Date.now();
  tapTimes.push(now);
  
  // Keep last 4 taps
  if(tapTimes.length > 4) tapTimes.shift();
  
  if(tapTimes.length >= 2) {
    const diffs = [];
    for(let i=1;i<tapTimes.length;i++) diffs.push(tapTimes[i]-tapTimes[i-1]);
    const avg = diffs.reduce((a,b)=>a+b,0) / diffs.length;
    bpm = Math.round(60000 / avg);
    bpm = Math.max(30, Math.min(300, bpm));
    updateBpmDisplay();
    applyBPM();
  }
  
  const btn = document.getElementById('tap-btn');
  btn.classList.add('tapped');
  setTimeout(() => btn.classList.remove('tapped'), 200);
  
  // Reset tap if no tap for 3 seconds
  clearTimeout(window._tapReset);
  window._tapReset = setTimeout(() => { tapTimes = []; }, 3000);
}

// ====================== TIME SIGNATURE ======================
function changeTimeSig() {
  beatsPerBar = parseInt(document.getElementById('time-sig').value);
  buildBeatLights();
  if(isRunning) {
    clearInterval(schedulerInterval);
    stepCounter = 0;
    const msPerStep = (60000 / bpm) / STEPS_PER_BEAT;
    schedulerInterval = setInterval(tick, msPerStep);
    tick();
  }
}

// ====================== BEAT LIGHTS ======================
function buildBeatLights() {
  const container = document.getElementById('beat-lights');
  container.innerHTML = '';
  for(let i=0;i<beatsPerBar;i++) {
    const dot = document.createElement('div');
    dot.className = 'beat-dot' + (i===0?' accent':'');
    container.appendChild(dot);
  }
}

// ====================== SWING ======================
function updateSwing() {
  swingAmount = parseFloat(document.getElementById('swing-select').value);
}

// ====================== LOAD SINGLE ======================
function loadSingleSound(idx) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'audio/*';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    await loadAudioFile(idx, file);
  };
  input.click();
}

async function loadAudioFile(idx, file) {
  try {
    const ctx = getAudioCtx();
    const ab = await file.arrayBuffer();
    const buffer = await ctx.decodeAudioData(ab);
    
    const pad = pads[idx];
    pad.buffer = buffer;
    pad.name = file.name.replace(/\.[^/.]+$/,'').substring(0,16).toUpperCase();
    pad.nameEl.textContent = pad.name;
    pad.el.classList.add('loaded');
    pad.el.querySelector('.pad-icon').textContent = 'üéµ';
    
    // Quick preview flash
    flashPad(idx);
  } catch(err) {
    console.error('Error loading audio:', err);
    alert('Errore nel caricamento: ' + err.message);
  }
}

// ====================== LOAD FOLDER ======================
async function loadFolder() {
  if(!('showDirectoryPicker' in window)) {
    // Fallback: multiple file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'audio/*';
    input.multiple = true;
    input.onchange = async (e) => {
      const files = Array.from(e.target.files).sort((a,b)=>a.name.localeCompare(b.name));
      const toLoad = Math.min(12, files.length);
      for(let i=0;i<toLoad;i++) await loadAudioFile(i, files[i]);
    };
    input.click();
    return;
  }
  
  try {
    const dirHandle = await window.showDirectoryPicker({ startIn: 'downloads' });
    const audioFiles = [];
    
    for await (const entry of dirHandle.values()) {
      if(entry.kind === 'file') {
        const file = await entry.getFile();
        if(/\.(mp3|wav|ogg|m4a|aac|flac|opus|weba)$/i.test(file.name)) {
          audioFiles.push(file);
        }
      }
    }
    
    if(!audioFiles.length) {
      alert('Nessun file audio trovato!');
      return;
    }
    
    audioFiles.sort((a,b)=>a.name.localeCompare(b.name));
    const toLoad = Math.min(12, audioFiles.length);
    
    for(let i=0;i<toLoad;i++) await loadAudioFile(i, audioFiles[i]);
    
    if(audioFiles.length > 12) {
      console.log(`Caricati 12 su ${audioFiles.length} file`);
    }
  } catch(err) {
    if(err.name !== 'AbortError') {
      console.error(err);
      // fallback to multi file
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'audio/*';
      input.multiple = true;
      input.onchange = async (e) => {
        const files = Array.from(e.target.files).sort((a,b)=>a.name.localeCompare(b.name));
        const toLoad = Math.min(12, files.length);
        for(let i=0;i<toLoad;i++) await loadAudioFile(i, files[i]);
      };
      input.click();
    }
  }
}

// ====================== CLEAR ======================
function clearAll() {
  if(!confirm('Cancellare tutti i suoni caricati?')) return;
  stopMetronome();
  pads.forEach((pad, i) => {
    pad.buffer = null;
    pad.name = '';
    pad.triggerOnBeat = false;
    pad.beatDiv = 1;
    pad.el.classList.remove('loaded','beat-active');
    pad.el.style.removeProperty('--pad-color');
    pad.nameEl.textContent = 'CARICA SUONO';
    pad.beatBtn.classList.remove('beat-on');
    pad.beatBtn.textContent = '‚ñ∏BEAT';
    pad.beatDivLabel.textContent = '1:1';
    pad.beatDivLabel.style.color = 'rgba(255,255,255,0.8)';
    pad.el.querySelector('.pad-icon').textContent = PAD_ICONS[i];
  });
}

// ====================== KEYBOARD ======================
document.addEventListener('keydown', (e) => {
  const keys = ['q','w','e','r','a','s','d','f','z','x','c','v'];
  const idx = keys.indexOf(e.key.toLowerCase());
  if(idx >= 0 && pads[idx].buffer) {
    playPad(idx);
    flashPad(idx);
    e.preventDefault();
  }
  if(e.code === 'Space') { e.preventDefault(); togglePlay(); }
});

// ====================== START ======================
window.onload = init;
</script>
</body>
</html>
