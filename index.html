<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>maracanaudio – Accordatore</title>

<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{
  width:100%;
  height:100%;
  background:#000;
  overflow:hidden;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}

.app{
  position:fixed;
  inset:0;
  display:flex;
  background:radial-gradient(circle at center,#151515 0%,#000 70%);
  color:#fff;
}

.tuner{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  justify-content:flex-start;
  padding:12px;
  gap:10px;
}

.topRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:14px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  font-weight:900;
}

.btn{
  border:none;
  cursor:pointer;
  padding:10px 14px;
  border-radius:14px;
  font-weight:900;
  color:#fff;
  background:#2a5298;
  transition:transform .12s ease, filter .12s ease;
  user-select:none;
}
.btn:active{transform:scale(0.98);}
.btn.secondary{background:rgba(255,255,255,0.12);}
.btn.danger{background:#dc3545;}

.readout{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  padding-top:2px;
}

.noteLine{
  font-size:48px;
  font-weight:1000;
  text-shadow:0 0 18px rgba(0,255,0,0.35);
}
.freqLine{
  font-size:22px;
  font-weight:900;
}
.deltaLine{
  font-size:18px;
  font-weight:900;
  color:#ffd700;
}

.meter{
  position:relative;
  flex:1;
  min-height:140px;
  border-radius:18px;
  background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));
  border:1px solid rgba(255,255,255,0.12);
  overflow:hidden;
}

.scale{
  position:absolute;
  inset:0;
  display:flex;
  justify-content:space-between;
  padding:0 24px;
}

.mark{
  width:2px;
  background:rgba(255,255,255,0.2);
  position:relative;
}
.mark.center{
  width:3px;
  background:#00ff00;
  box-shadow:0 0 16px rgba(0,255,0,0.6);
}

.label{
  position:absolute;
  bottom:8px;
  left:50%;
  transform:translateX(-50%);
  font-size:12px;
  font-weight:900;
  opacity:0.7;
  white-space:nowrap;
}

.needle{
  position:absolute;
  top:10%;
  height:80%;
  width:4px;
  left:50%;
  transform:translateX(-50%);
  border-radius:2px;
  background:#ff3333;
  box-shadow:0 0 16px rgba(255,0,0,0.6);
  transition:left .08s ease-out;
}
.needle.ok{
  background:#00ff00;
  box-shadow:0 0 18px rgba(0,255,0,0.7);
}

.status{
  text-align:center;
  padding:8px;
  border-radius:14px;
  font-weight:1000;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
}
.status.good{background:rgba(0,255,0,0.18); color:#d9ffd9; border-color:rgba(0,255,0,0.25);}
.status.low{background:rgba(255,68,68,0.18); border-color:rgba(255,68,68,0.25);}
.status.high{background:rgba(255,136,0,0.18); border-color:rgba(255,136,0,0.25);}

.overlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.82);
  z-index:999;
  padding:14px;
}
.overlayCard{
  width:min(520px,96vw);
  background:#fff;
  color:#111;
  border-radius:18px;
  padding:18px;
  box-shadow:0 18px 70px rgba(0,0,0,0.45);
  text-align:center;
}
.overlayCard h2{font-size:20px;font-weight:1000;margin-bottom:8px;}
.overlayCard p{font-size:14px;font-weight:750;color:#444;line-height:1.4;margin-bottom:14px;}
.overlayRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.overlayRow .btn{min-width:160px;}
.err{
  display:none;
  margin-top:12px;
  color:#b00020;
  font-weight:900;
  font-size:13px;
}

.refModal{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.72);
  z-index:1200;
  padding:14px;
}
.refModal.show{display:flex;}
.refCard{
  width:min(520px,96vw);
  background:#fff;
  color:#111;
  border-radius:18px;
  padding:18px;
  text-align:left;
  box-shadow:0 18px 70px rgba(0,0,0,0.45);
}
.refCard h3{font-size:18px;font-weight:1000;margin-bottom:10px;}
.refRow{display:flex;gap:10px;align-items:center;}
.refRow input{
  flex:1;
  padding:12px 12px;
  border-radius:14px;
  border:2px solid #ddd;
  font-size:16px;
  font-weight:900;
  outline:none;
}
.hint{margin-top:10px;font-size:13px;font-weight:800;color:#555;}

@media (orientation:landscape) and (max-height:520px){
  .topRow{display:none;}
  .readout{gap:2px;}
  .noteLine{font-size:30px;}
  .freqLine{font-size:16px;}
  .deltaLine{font-size:14px;}
  .meter{flex:1;min-height:160px;}
  .status{font-size:14px;padding:6px;}
}
</style>
</head>

<body>
<div class="app">
  <div class="tuner" id="tunerRoot">
    <div class="topRow">
      <div class="pill">A4 <span id="refVal">440.0 Hz</span></div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn secondary" id="refBtn">LA (A4)</button>
        <button class="btn danger" id="stopBtn" style="display:none;">STOP</button>
      </div>
    </div>

    <div class="readout">
      <div class="noteLine" id="noteName">—</div>
      <div class="freqLine" id="freqNow">— Hz</div>
      <div class="deltaLine" id="deltaNow">0 cents</div>
    </div>

    <div class="meter" id="meter">
      <div class="scale" id="scale"></div>
      <div class="needle" id="needle"></div>
    </div>

    <div class="status" id="status">Tocca AVVIA per iniziare</div>
  </div>
</div>

<div class="overlay" id="startOverlay">
  <div class="overlayCard">
    <h2>Accordatore</h2>
    <p>
      Tocca “AVVIA” per attivare il microfono.
      <br/>LA di riferimento: <b id="overlayRef">440.0 Hz</b>
    </p>
    <div class="overlayRow">
      <button class="btn secondary" id="overlayRefBtn">Cambia LA</button>
      <button class="btn" id="startBtn">AVVIA</button>
    </div>
    <div class="err" id="overlayErr"></div>
  </div>
</div>

<div class="refModal" id="refModal">
  <div class="refCard">
    <h3>Imposta LA (A4) manualmente</h3>
    <div class="refRow">
      <input id="refInput" type="number" min="380" max="520" step="0.1" value="440.0" />
      <button class="btn" id="refApply">Applica</button>
    </div>
    <div class="hint">Suggeriti: 440 (standard), 432, 442.</div>
    <div style="display:flex;gap:10px;margin-top:12px;">
      <button class="btn secondary" id="refClose">Chiudi</button>
    </div>
  </div>
</div>

<script>
"use strict";

let audioContext, analyser, micSource, streamRef, rafId;
let isRunning = false;

let referenceA4 = 440.0;

const refVal = document.getElementById('refVal');
const overlayRef = document.getElementById('overlayRef');
const noteNameEl = document.getElementById('noteName');
const freqNowEl = document.getElementById('freqNow');
const deltaNowEl = document.getElementById('deltaNow');
const statusEl = document.getElementById('status');
const needleEl = document.getElementById('needle');
const scaleEl = document.getElementById('scale');
const stopBtn = document.getElementById('stopBtn');

const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const overlayRefBtn = document.getElementById('overlayRefBtn');
const overlayErr = document.getElementById('overlayErr');

const refBtn = document.getElementById('refBtn');
const refModal = document.getElementById('refModal');
const refInput = document.getElementById('refInput');
const refApply = document.getElementById('refApply');
const refClose = document.getElementById('refClose');

const NOTE_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTE_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function freqToMidi(f){
  return 69 + 12 * Math.log2(f / referenceA4);
}
function midiToFreq(m){
  return referenceA4 * Math.pow(2, (m - 69) / 12);
}
function midiToName(midi, preferFlats){
  const n = Math.round(midi);
  const octave = Math.floor(n / 12) - 1;
  const idx = (n % 12 + 12) % 12;
  const name = preferFlats ? NOTE_FLAT[idx] : NOTE_SHARP[idx];
  return { name, octave, idx, midiRounded: n };
}
function centsDiff(freq, target){
  return 1200 * Math.log2(freq / target);
}
function formatNameBoth(midi){
  const sharp = midiToName(midi, false);
  const flat  = midiToName(midi, true);
  if (sharp.name !== flat.name){
    return `${sharp.name}${sharp.octave} / ${flat.name}${flat.octave}`;
  }
  return `${sharp.name}${sharp.octave}`;
}

function getZoomRange(absCents){
  if (absCents > 80) return 150;
  if (absCents > 40) return 80;
  if (absCents > 20) return 40;
  if (absCents > 10) return 20;
  if (absCents > 5)  return 10;
  return 5;
}

function drawScale(range){
  scaleEl.innerHTML = "";
  let step = 10;
  if (range <= 20) step = 5;
  if (range <= 10) step = 2;
  if (range <= 5)  step = 1;

  for (let c = -range; c <= range; c += step){
    const mark = document.createElement("div");
    mark.className = (c === 0) ? "mark center" : "mark";

    const major = (range >= 80) ? 20 : (range >= 40 ? 10 : (range >= 20 ? 10 : (range >= 10 ? 5 : 2)));
    if (c === 0 || (Math.abs(c) % major === 0)){
      const lab = document.createElement("span");
      lab.className = "label";
      lab.textContent = c;
      mark.appendChild(lab);
    }
    scaleEl.appendChild(mark);
  }
}

let smoothFreq = null;
let lastStableMidi = null;
let stableFrames = 0;
const STABLE_FRAMES_REQUIRED = 4;
const NOTE_HYSTERESIS_CENTS = 18;

const RMS_MIN = 0.018;
const CONF_MIN = 0.65;

function autoCorrelateFloat32(buf, sampleRate){
  const SIZE = buf.length;
  let rms = 0;
  for (let i=0;i<SIZE;i++){
    const v = buf[i];
    rms += v*v;
  }
  rms = Math.sqrt(rms / SIZE);
  if (rms < RMS_MIN) return { freq: -1, confidence: 0, rms };

  let mean = 0;
  for (let i=0;i<SIZE;i++) mean += buf[i];
  mean /= SIZE;
  for (let i=0;i<SIZE;i++) buf[i] -= mean;

  const MAX_SAMPLES = Math.floor(SIZE/2);
  let bestOffset = -1;
  let bestCorr = 0;
  let lastCorr = 1;

  for (let offset=16; offset < MAX_SAMPLES; offset++){
    let corr = 0;
    for (let i=0;i<MAX_SAMPLES;i++){
      const d = buf[i] - buf[i+offset];
      corr += d*d;
    }
    corr = 1 - (corr / MAX_SAMPLES);

    if (corr > 0.85 && corr > lastCorr){
      if (corr > bestCorr){
        bestCorr = corr;
        bestOffset = offset;
      }
    }
    lastCorr = corr;
  }

  if (bestOffset === -1 || bestCorr < 0.01) return { freq: -1, confidence: 0, rms };
  const freq = sampleRate / bestOffset;
  const confidence = clamp(bestCorr * (rms / 0.08), 0, 1);
  return { freq, confidence, rms };
}

let lastRange = 150;

function setStatus(type, text){
  statusEl.className = "status" + (type ? (" " + type) : "");
  statusEl.textContent = text;
}

function updateUI(freq){
  const midi = freqToMidi(freq);
  const midiRounded = Math.round(midi);
  const targetFreq = midiToFreq(midiRounded);
  const cents = centsDiff(freq, targetFreq);

  const absC = Math.abs(cents);
  const range = getZoomRange(absC);

  if (range !== lastRange){
    lastRange = range;
    drawScale(range);
  }

  const clampedC = clamp(cents, -range, range);
  const maxOffsetPct = 48;
  const offsetPct = (clampedC / range) * maxOffsetPct;
  needleEl.style.left = `calc(50% + ${offsetPct}%)`;

  if (absC <= 3) needleEl.classList.add("ok");
  else needleEl.classList.remove("ok");

  noteNameEl.textContent = formatNameBoth(midi);
  freqNowEl.textContent = `${freq.toFixed(2)} Hz`;
  deltaNowEl.textContent = `${cents >= 0 ? "+" : ""}${Math.round(cents)} cents`;

  if (absC <= 3){
    setStatus("good", "✓ Perfetto (±3 cents)");
  } else if (absC <= 8){
    setStatus(cents < 0 ? "low" : "high", cents < 0 ? "↓ Alza leggermente" : "↑ Abbassa leggermente");
  } else {
    setStatus(cents < 0 ? "low" : "high", cents < 0 ? "↓ Troppo bassa (tira)" : "↑ Troppo alta (molla)");
  }
}

const FFT_SIZE = 2048;
const BUF = new Float32Array(FFT_SIZE);

function tick(){
  if (!isRunning) return;

  analyser.getFloatTimeDomainData(BUF);
  const tmp = new Float32Array(BUF);
  const { freq, confidence } = autoCorrelateFloat32(tmp, audioContext.sampleRate);

  const valid = (freq > 40 && freq < 2000 && confidence >= CONF_MIN);
  if (!valid){
    stableFrames = 0;
    setStatus("", "Ascolto… (suona una nota)");
    rafId = requestAnimationFrame(tick);
    return;
  }

  const alpha = 0.22;
  smoothFreq = (smoothFreq == null) ? freq : (smoothFreq*(1-alpha) + freq*alpha);

  const midiNow = freqToMidi(smoothFreq);
  const midiRounded = Math.round(midiNow);

  if (lastStableMidi == null){
    lastStableMidi = midiRounded;
    stableFrames = 1;
  } else {
    const targetFreqStable = midiToFreq(lastStableMidi);
    const centsFromStable = centsDiff(smoothFreq, targetFreqStable);

    if (Math.abs(centsFromStable) <= NOTE_HYSTERESIS_CENTS){
      stableFrames++;
    } else {
      stableFrames = Math.max(0, stableFrames - 1);
      if (stableFrames <= 0){
        lastStableMidi = midiRounded;
        stableFrames = 1;
      }
    }
  }

  if (stableFrames >= STABLE_FRAMES_REQUIRED){
    updateUI(smoothFreq);
  } else {
    setStatus("", "Stabilizzo…");
  }

  rafId = requestAnimationFrame(tick);
}

async function enterFullscreen(){
  try{
    if (!document.fullscreenElement){
      await document.documentElement.requestFullscreen({ navigationUI: "hide" });
    }
  }catch(e){}
}
async function exitFullscreen(){
  try{
    if (document.fullscreenElement){
      await document.exitFullscreen();
    }
  }catch(e){}
}

async function start(){
  overlayErr.style.display = "none";
  overlayErr.textContent = "";
  try{
    streamRef = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false }
    });

    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = FFT_SIZE;

    micSource = audioContext.createMediaStreamSource(streamRef);
    micSource.connect(analyser);

    isRunning = true;
    smoothFreq = null;
    lastStableMidi = null;
    stableFrames = 0;

    startOverlay.style.display = "none";
    stopBtn.style.display = "inline-flex";
    setStatus("", "Ascolto… (suona una nota)");

    lastRange = 999;
    drawScale(150);
    lastRange = 150;

    await enterFullscreen();

    if (rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(tick);

  }catch(err){
    overlayErr.textContent = "Permesso microfono negato/non disponibile. Controlla permessi del browser e riprova.";
    overlayErr.style.display = "block";
  }
}

function stop(){
  isRunning = false;
  if (rafId) cancelAnimationFrame(rafId);
  rafId = null;

  try{ if (micSource) micSource.disconnect(); }catch(e){}
  try{ if (audioContext) audioContext.close(); }catch(e){}
  if (streamRef){
    try{ streamRef.getTracks().forEach(t => t.stop()); }catch(e){}
  }

  micSource = null; analyser = null; audioContext = null; streamRef = null;
  smoothFreq = null; lastStableMidi = null; stableFrames = 0;

  stopBtn.style.display = "none";
  setStatus("", "Fermato");
  noteNameEl.textContent = "—";
  freqNowEl.textContent = "— Hz";
  deltaNowEl.textContent = "0 cents";
  needleEl.style.left = "50%";
  needleEl.classList.remove("ok");

  startOverlay.style.display = "flex";
  exitFullscreen();
}

function setReference(val){
  referenceA4 = clamp(Number(val || 440), 380, 520);
  refVal.textContent = `${referenceA4.toFixed(1)} Hz`;
  overlayRef.textContent = `${referenceA4.toFixed(1)} Hz`;
  refInput.value = referenceA4.toFixed(1);
}
setReference(440);

function openRefModal(){ refModal.classList.add("show"); }
function closeRefModal(){ refModal.classList.remove("show"); }

startBtn.addEventListener("click", start, { passive:true });
stopBtn.addEventListener("click", stop, { passive:true });

overlayRefBtn.addEventListener("click", openRefModal, { passive:true });
refBtn.addEventListener("click", openRefModal, { passive:true });

refApply.addEventListener("click", () => {
  setReference(refInput.value);
  closeRefModal();
}, { passive:true });

refClose.addEventListener("click", closeRefModal, { passive:true });

refModal.addEventListener("click", (e) => {
  if (e.target === refModal) closeRefModal();
});
document.addEventListener("visibilitychange", () => {
  if (document.hidden && isRunning) stop();
});
startOverlay.style.display = "flex";
</script>
</body>
</html>
