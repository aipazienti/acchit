<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>Accordatore</title>

  <!-- PWA Meta Tags -->
  <meta name="description" content="Accordatore professionale per chitarra con riconoscimento automatico corde e zoom progressivo">
  <meta name="theme-color" content="#2a5298">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Accordatore">

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;width:100%;overflow:hidden;}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      height: 100dvh;
      width: 100vw;
      display:flex;
      justify-content:center;
      align-items:stretch;
      padding:0;
    }

    .container{
      width:100%;
      height:100%;
      max-width:none;
      max-height:100dvh;
      background:#fff;
      border-radius:0;
      padding:14px;
      box-shadow:none;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
    }

    /* Controls */
    .controls{
      background:#f5f5f5;
      padding:12px;
      border-radius:10px;
      flex:0 0 auto;
    }
    .control-group{margin-bottom:12px;}
    label{
      display:block;
      margin-bottom:6px;
      color:#333;
      font-weight:700;
      font-size:13px;
    }
    .reference-input{display:flex;align-items:center;gap:10px;}
    input[type="number"]{
      flex:1;
      padding:10px;
      border:2px solid #ddd;
      border-radius:8px;
      font-size:16px;
      outline:none;
    }

    .btn{
      padding:12px 18px;
      border:none;
      border-radius:10px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      transition:transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      user-select:none;
    }
    .btn-primary{background:#2a5298;color:#fff;}
    .btn-primary:hover{background:#1e3c72;transform:translateY(-1px);box-shadow:0 10px 20px rgba(42,82,152,0.25);}
    .btn-danger{background:#dc3545;color:#fff;}
    .btn-danger:hover{background:#c82333;}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none;}

    /* Tuner display */
    .tuner-display{
      background:#000;
      border-radius:15px;
      padding:14px;
      position:relative;
      flex:1 1 auto;
      min-height:0;
      display:none; /* shown when running */
    }

    .string-detected{text-align:center;margin-bottom:10px;}
    .string-name{
      font-size: clamp(28px, 5vw, 48px);
      font-weight:900;
      color:#00ff00;
      text-shadow:0 0 18px #00ff00;
      letter-spacing:0.5px;
    }
    .target-freq{font-size:14px;color:#888;margin-top:3px;}

    .frequency-display{text-align:center;margin-bottom:10px;}
    .current-freq{
      font-size: clamp(22px, 4.2vw, 36px);
      color:#fff;
      font-weight:900;
    }
    .cents-display{font-size:18px;color:#ffd700;margin-top:4px;font-weight:700;}

    .tuner-meter{
      position:relative;
      height: clamp(90px, 18vh, 160px);
      margin-bottom: 12px;
      background:#121212;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
    }
    .meter-scale{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:space-between;
      padding:0 clamp(10px, 2vw, 24px);
      align-items:stretch;
    }
    .scale-mark{
      width:2px;
      background:#444;
      position:relative;
      opacity:0.85;
    }
    .scale-mark.center{width:3px;background:#00ff00;opacity:1;}
    .scale-label{
      position:absolute;
      bottom:6px;
      left:50%;
      transform:translateX(-50%);
      color:#9a9a9a;
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
    }

    .needle{
      position:absolute;
      top:10%;
      width:4px;
      height:80%;
      background:#ff0000;
      left:50%;
      transform:translateX(-50%);
      transition: left 0.1s ease-out;
      box-shadow:0 0 10px #ff0000;
      border-radius:2px;
    }
    .needle.in-tune{background:#00ff00;box-shadow:0 0 18px #00ff00;}

    .status-indicator{
      text-align:center;
      padding:10px;
      border-radius:10px;
      font-weight:900;
      font-size:16px;
      margin-bottom:8px;
      display:none;
    }
    .status-low{background:#ff4444;color:#fff;}
    .status-high{background:#ff8800;color:#fff;}
    .status-perfect{background:#00ff00;color:#000;}

    .zoom-indicator{
      text-align:center;
      font-size:13px;
      font-weight:800;
      margin-top:6px;
      padding:9px 12px;
      border-radius:10px;
      background: rgba(255,255,255,0.08);
    }

    .strings-reference{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      flex:0 0 auto;
    }
    .string-card{
      background:#f9f9f9;
      padding:10px;
      border-radius:10px;
      text-align:center;
      border:2px solid transparent;
      transition:all 0.2s;
    }
    .string-card.active{border-color:#00ff00;background:#e8ffe8;}
    .string-card-name{font-size:20px;font-weight:900;color:#1e3c72;}
    .string-card-freq{font-size:12px;color:#666;margin-top:5px;font-weight:700;}

    .listening{animation:pulse 1.5s infinite;}
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.55;}}

    /* Desktop polish */
    @media (min-width: 900px){
      body{align-items:center;}
      .container{
        max-width:980px;
        height:min(100dvh,920px);
        border-radius:20px;
        padding:22px;
        box-shadow:0 20px 60px rgba(0,0,0,0.3);
      }
      .tuner-display{padding:22px;}
      .controls{padding:16px;}
    }

    @media (max-width: 600px){
      .strings-reference{grid-template-columns:repeat(3,1fr);}
    }

    /* ===== ANDROID LANDSCAPE: meter enorme + UI minimale ===== */
    @media (orientation: landscape) and (max-height: 500px){
      .container{padding:10px !important; gap:8px !important;}

      /* Nascondi cose secondarie in landscape */
      .reference-input, label { display:none !important; }
      .strings-reference { display:none !important; }
      .zoom-indicator { display:none !important; }

      .controls{
        background:transparent !important;
        padding:0 !important;
        border-radius:0 !important;
        margin:0 !important;
      }

      /* Tuner display prende tutto */
      .tuner-display{
        display:block;
        padding:12px !important;
        flex:1 1 auto !important;
      }

      .tuner-meter{
        height: clamp(140px, 34vh, 220px) !important;
        margin-bottom: 10px !important;
      }

      .string-name{font-size: clamp(24px, 6vw, 34px) !important;}
      .current-freq{font-size: clamp(20px, 5vw, 30px) !important;}
      .status-indicator{font-size: 15px !important; padding:8px !important;}

      /* Pulsante start/stop flottante sempre visibile */
      #startBtn{
        position: fixed !important;
        top: 10px !important;
        right: 10px !important;
        z-index: 2500 !important;
        padding: 12px 14px !important;
        border-radius: 14px !important;
        box-shadow: 0 14px 40px rgba(0,0,0,0.35) !important;
      }
    }

    /* ===== Modal ===== */
    .modal-overlay{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.72);
      z-index:3000;
      justify-content:center;
      align-items:center;
      padding:14px;
      animation:fadeIn 0.25s;
    }
    .modal-overlay.show{display:flex;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal-content{
      background:#fff;
      border-radius:16px;
      padding:22px;
      max-width:480px;
      width:min(92vw,480px);
      box-shadow:0 10px 40px rgba(0,0,0,0.35);
      animation:slideUp 0.25s;
    }
    @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{text-align:center;margin-bottom:14px;}
    .modal-icon{font-size:60px;margin-bottom:8px;}
    .modal-title{font-size:22px;color:#1e3c72;margin-bottom:6px;font-weight:900;}
    .modal-message{font-size:15px;color:#555;line-height:1.5;margin-bottom:16px;}
    .modal-steps{background:#f5f5f5;padding:14px;border-radius:12px;margin-bottom:14px;}
    .modal-step{display:flex;align-items:flex-start;margin-bottom:10px;font-size:14px;color:#333;font-weight:700;}
    .modal-step:last-child{margin-bottom:0;}
    .step-number{
      background:#2a5298;color:#fff;width:24px;height:24px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;
      margin-right:10px;flex-shrink:0;
    }
    .modal-buttons{display:flex;gap:10px;}
    .modal-btn{
      flex:1;padding:12px;border:none;border-radius:10px;font-size:16px;font-weight:900;cursor:pointer;
      transition:background 0.15s ease, transform 0.15s ease;
    }
    .modal-btn-primary{background:#2a5298;color:#fff;}
    .modal-btn-primary:hover{background:#1e3c72;}
    .modal-btn-secondary{background:#e0e0e0;color:#333;}
    .modal-btn-secondary:hover{background:#d0d0d0;}

    .error-message{
      background:#ffe6e6;border-left:4px solid #dc3545;
      padding:12px;border-radius:8px;margin-top:12px;display:none;
    }
    .error-message.show{display:block;}
    .error-title{font-weight:900;color:#dc3545;margin-bottom:6px;}
    .error-text{font-size:13px;color:#555;line-height:1.45;}
    .permission-granted{
      background:#e6ffe6;border-left:4px solid #00ff00;
      padding:12px;border-radius:8px;margin-top:12px;text-align:center;display:none;
    }
    .permission-granted.show{display:block;}
    .permission-granted-icon{font-size:44px;margin-bottom:8px;}
    .permission-granted-text{color:#2d5016;font-weight:900;}

    /* ===== Fullscreen prompt overlay ===== */
    #fsPrompt{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.72);
      z-index:2600;
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    #fsPrompt.show{display:flex;}
    .fsPromptCard{
      width:min(520px,96vw);
      background:#fff;
      border-radius:16px;
      padding:18px;
      box-shadow:0 18px 60px rgba(0,0,0,0.35);
      text-align:center;
    }
    .fsTitle{font-weight:900;font-size:20px;color:#1e3c72;margin-bottom:8px;}
    .fsText{color:#444;font-size:14px;margin-bottom:14px;font-weight:700;}
  </style>
</head>

<body>

  <!-- FULLSCREEN PROMPT (landscape) -->
  <div id="fsPrompt" aria-hidden="true">
    <div class="fsPromptCard">
      <div class="fsTitle">Schermo intero</div>
      <div class="fsText">Tocca per usare l‚Äôaccordatore a pieno schermo.</div>
      <button id="fsBtn" class="btn btn-primary">‚õ∂ FULLSCREEN</button>
    </div>
  </div>

  <!-- Modal Popup per richiesta accesso microfono -->
  <div class="modal-overlay" id="microphoneModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon">üé§</div>
        <h2 class="modal-title">Richiesta Accesso Microfono</h2>
      </div>

      <p class="modal-message">
        Per accordare la chitarra, l‚Äôapp deve accedere al microfono del tuo dispositivo.
      </p>

      <div class="modal-steps">
        <div class="modal-step">
          <span class="step-number">1</span>
          <span>Clicca su ‚ÄúConsenti Accesso‚Äù qui sotto</span>
        </div>
        <div class="modal-step">
          <span class="step-number">2</span>
          <span>Il browser mostrer√† un popup di permessi</span>
        </div>
        <div class="modal-step">
          <span class="step-number">3</span>
          <span>Seleziona ‚ÄúConsenti / Allow‚Äù</span>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeMicrophoneModal()">Annulla</button>
        <button class="modal-btn modal-btn-primary" onclick="requestMicrophoneAccess()">üé§ Consenti Accesso</button>
      </div>

      <div class="error-message" id="errorMessage">
        <div class="error-title">‚ö†Ô∏è Accesso Negato</div>
        <div class="error-text" id="errorText"></div>
      </div>

      <div class="permission-granted" id="permissionGranted">
        <div class="permission-granted-icon">‚úÖ</div>
        <div class="permission-granted-text">Accesso consentito! Avvio accordatore...</div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Titolo rimosso su richiesta -->

    <div class="controls">
      <div class="control-group">
        <label for="referenceFreq">Frequenza di Riferimento LA (Hz)</label>
        <div class="reference-input">
          <input type="number" id="referenceFreq" value="440" min="430" max="450" step="0.1">
          <button class="btn btn-primary" onclick="updateReference(true)">Applica</button>
        </div>
      </div>

      <div class="control-group" style="text-align:center; margin-top: 6px;">
        <button id="startBtn" class="btn btn-primary" onclick="toggleTuner()">üé§ Avvia Accordatore</button>
      </div>
    </div>

    <div class="tuner-display" id="tunerDisplay">
      <div class="string-detected">
        <div class="string-name" id="stringName">-</div>
        <div class="target-freq" id="targetFreq">Suona una corda</div>
      </div>

      <div class="frequency-display">
        <div class="current-freq" id="currentFreq">--- Hz</div>
        <div class="cents-display" id="centsDisplay">0 cents</div>
      </div>

      <div class="tuner-meter" id="tunerMeter">
        <div class="meter-scale" id="meterScale"></div>
        <div class="needle" id="needle"></div>
      </div>

      <div class="status-indicator" id="statusIndicator">Accordatura perfetta! ‚úì</div>
      <div class="zoom-indicator" id="zoomIndicator"></div>
    </div>

    <div class="strings-reference">
      <div class="string-card" data-string="E2">
        <div class="string-card-name">E</div>
        <div class="string-card-freq" id="freq-E2">82.41 Hz</div>
      </div>
      <div class="string-card" data-string="A2">
        <div class="string-card-name">A</div>
        <div class="string-card-freq" id="freq-A2">110.00 Hz</div>
      </div>
      <div class="string-card" data-string="D3">
        <div class="string-card-name">D</div>
        <div class="string-card-freq" id="freq-D3">146.83 Hz</div>
      </div>
      <div class="string-card" data-string="G3">
        <div class="string-card-name">G</div>
        <div class="string-card-freq" id="freq-G3">196.00 Hz</div>
      </div>
      <div class="string-card" data-string="B3">
        <div class="string-card-name">B</div>
        <div class="string-card-freq" id="freq-B3">246.94 Hz</div>
      </div>
      <div class="string-card" data-string="E4">
        <div class="string-card-name">E</div>
        <div class="string-card-freq" id="freq-E4">329.63 Hz</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Configurazione globale =====
    let audioContext;
    let analyser;
    let microphone;
    let scriptProcessor;
    let isRunning = false;
    let referenceA4 = 440;

    // Zoom levels
    let zoomLevel = 1; // 1 = (-50/+50), 2 = (-20/+20), 3 = (-10/+10)
    let lastCents = 0;
    let stableCount = 0;
    const ZOOM_STABILITY_REQUIRED = 5;

    // Note standard della chitarra (semitoni rispetto a LA4)
    const guitarStrings = {
      'E2': { name: 'E (6¬™)', semitone: -29 },
      'A2': { name: 'A (5¬™)', semitone: -24 },
      'D3': { name: 'D (4¬™)', semitone: -19 },
      'G3': { name: 'G (3¬™)', semitone: -14 },
      'B3': { name: 'B (2¬™)', semitone: -10 },
      'E4': { name: 'E (1¬™)', semitone: -5 }
    };

    function getFrequency(semitones) {
      return referenceA4 * Math.pow(2, semitones / 12);
    }

    // Aggiorna tutte le frequenze di riferimento (senza alert all'avvio)
    function updateReference(showToast) {
      const input = document.getElementById('referenceFreq');
      referenceA4 = parseFloat(input.value);

      Object.keys(guitarStrings).forEach(note => {
        const freq = getFrequency(guitarStrings[note].semitone);
        document.getElementById(`freq-${note}`).textContent = freq.toFixed(2) + ' Hz';
      });

      if (showToast) {
        // micro feedback senza alert invasivo
        const status = document.getElementById('statusIndicator');
        status.className = 'status-indicator status-high';
        status.textContent = `LA di riferimento: ${referenceA4.toFixed(1)} Hz`;
        status.style.display = 'block';
        setTimeout(() => { if (!isRunning) status.style.display = 'none'; }, 1200);
      }
    }
    updateReference(false);

    function findClosestString(frequency) {
      let closest = null;
      let minDiff = Infinity;

      Object.keys(guitarStrings).forEach(note => {
        const targetFreq = getFrequency(guitarStrings[note].semitone);
        const diff = Math.abs(frequency - targetFreq);
        if (diff < minDiff) {
          minDiff = diff;
          closest = { note, targetFreq, ...guitarStrings[note] };
        }
      });

      return closest;
    }

    function getCents(frequency, targetFrequency) {
      return Math.floor(1200 * Math.log2(frequency / targetFrequency));
    }

    function updateZoom(cents) {
      const absCents = Math.abs(cents);
      let newZoomLevel = zoomLevel;

      if (absCents <= 8) newZoomLevel = 3;
      else if (absCents <= 25) newZoomLevel = 2;
      else newZoomLevel = 1;

      if (newZoomLevel !== zoomLevel) {
        const centsVariation = Math.abs(cents - lastCents);
        if (centsVariation < 3) stableCount++;
        else stableCount = 0;

        if (stableCount >= ZOOM_STABILITY_REQUIRED) {
          zoomLevel = newZoomLevel;
          stableCount = 0;
        }
      } else {
        stableCount = 0;
      }

      lastCents = cents;
    }

    function drawMeterScale() {
      const meterScale = document.getElementById('meterScale');
      meterScale.innerHTML = '';

      let range, step;
      switch (zoomLevel) {
        case 3: range = 10; step = 2; break;
        case 2: range = 20; step = 5; break;
        default: range = 50; step = 10;
      }

      for (let i = -range; i <= range; i += step) {
        const mark = document.createElement('div');
        mark.className = i === 0 ? 'scale-mark center' : 'scale-mark';

        if (i % (step * 2) === 0 || i === 0) {
          const label = document.createElement('span');
          label.className = 'scale-label';
          label.textContent = i;
          mark.appendChild(label);
        }
        meterScale.appendChild(mark);
      }
    }

    function updateDisplay(frequency, closestString) {
      if (!closestString) return;

      const cents = getCents(frequency, closestString.targetFreq);
      updateZoom(cents);
      drawMeterScale();

      document.getElementById('stringName').textContent = closestString.name;
      document.getElementById('targetFreq').textContent = `Target: ${closestString.targetFreq.toFixed(2)} Hz`;
      document.getElementById('currentFreq').textContent = frequency.toFixed(2) + ' Hz';
      document.getElementById('centsDisplay').textContent = `${cents > 0 ? '+' : ''}${cents} cents`;

      const needle = document.getElementById('needle');
      let range, maxOffset = 48;
      if (zoomLevel === 3) range = 10;
      else if (zoomLevel === 2) range = 20;
      else range = 50;

      const clamped = Math.max(-range, Math.min(range, cents));
      const offset = (clamped / range) * maxOffset;
      needle.style.left = `calc(50% + ${offset}%)`;

      const absCents = Math.abs(cents);
      needle.className = (absCents <= 3) ? 'needle in-tune' : 'needle';

      const status = document.getElementById('statusIndicator');
      if (absCents <= 3) {
        status.className = 'status-indicator status-perfect';
        status.textContent = '‚úì Perfetto! Accordatura ottimale';
        status.style.display = 'block';
      } else if (absCents <= 8) {
        status.style.display = 'block';
        if (cents < 0) {
          status.className = 'status-indicator status-low';
          status.textContent = `‚Üì Quasi perfetto - alza leggermente (${cents} cents)`;
        } else {
          status.className = 'status-indicator status-high';
          status.textContent = `‚Üë Quasi perfetto - abbassa leggermente (+${cents} cents)`;
        }
      } else if (cents < 0) {
        status.className = 'status-indicator status-low';
        status.textContent = `‚Üì Troppo bassa - alza la tensione (${cents} cents)`;
        status.style.display = 'block';
      } else {
        status.className = 'status-indicator status-high';
        status.textContent = `‚Üë Troppo alta - abbassa la tensione (+${cents} cents)`;
        status.style.display = 'block';
      }

      const zoomIndicator = document.getElementById('zoomIndicator');
      if (zoomLevel === 3) {
        zoomIndicator.textContent = 'üéØ AFFINATURA FINALE (¬±10 cents)';
        zoomIndicator.style.color = '#00ff00';
      } else if (zoomLevel === 2) {
        zoomIndicator.textContent = 'üîç AVVICINAMENTO (¬±20 cents)';
        zoomIndicator.style.color = '#ffd700';
      } else {
        zoomIndicator.textContent = 'üìä VISTA AMPIA (¬±50 cents)';
        zoomIndicator.style.color = '#9a9a9a';
      }

      document.querySelectorAll('.string-card').forEach(card => card.classList.remove('active'));
      const active = document.querySelector(`[data-string="${closestString.note}"]`);
      if (active) active.classList.add('active');
    }

    // Autocorrelazione per rilevare pitch
    function autoCorrelate(buffer, sampleRate) {
      const SIZE = buffer.length;
      const MAX_SAMPLES = Math.floor(SIZE / 2);
      let best_offset = -1;
      let best_correlation = 0;
      let rms = 0;

      for (let i = 0; i < SIZE; i++) {
        const val = buffer[i];
        rms += val * val;
      }
      rms = Math.sqrt(rms / SIZE);
      if (rms < 0.01) return -1;

      let lastCorrelation = 1;
      for (let offset = 1; offset < MAX_SAMPLES; offset++) {
        let correlation = 0;
        for (let i = 0; i < MAX_SAMPLES; i++) {
          correlation += Math.abs(buffer[i] - buffer[i + offset]);
        }
        correlation = 1 - (correlation / MAX_SAMPLES);

        if (correlation > 0.9 && correlation > lastCorrelation) {
          if (correlation > best_correlation) {
            best_correlation = correlation;
            best_offset = offset;
          }
        }
        lastCorrelation = correlation;
      }

      if (best_correlation > 0.01 && best_offset !== -1) {
        return sampleRate / best_offset;
      }
      return -1;
    }

    function processAudio(event) {
      const buffer = event.inputBuffer.getChannelData(0);
      const frequency = autoCorrelate(buffer, audioContext.sampleRate);

      // Range chitarra
      if (frequency > 0 && frequency >= 70 && frequency <= 400) {
        const closest = findClosestString(frequency);
        updateDisplay(frequency, closest);
      }
    }

    // ===== Modal permessi =====
    function showMicrophoneModal() {
      const modal = document.getElementById('microphoneModal');
      document.getElementById('errorMessage').classList.remove('show');
      document.getElementById('permissionGranted').classList.remove('show');
      modal.classList.add('show');
    }

    function closeMicrophoneModal() {
      document.getElementById('microphoneModal').classList.remove('show');
    }

    async function requestMicrophoneAccess() {
      const errorMessage = document.getElementById('errorMessage');
      const permissionGranted = document.getElementById('permissionGranted');

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false
          }
        });

        errorMessage.classList.remove('show');
        permissionGranted.classList.add('show');

        setTimeout(() => {
          closeMicrophoneModal();
          startTuner(stream);
        }, 900);

      } catch (error) {
        console.error('Errore accesso microfono:', error);
        errorMessage.classList.add('show');
        permissionGranted.classList.remove('show');

        let msg = 'Accesso al microfono non disponibile. ';
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          msg = 'Hai negato l‚Äôaccesso al microfono. ';
        } else if (error.name === 'NotFoundError') {
          msg = 'Nessun microfono trovato sul dispositivo. ';
        } else if (error.name === 'NotReadableError') {
          msg = 'Il microfono √® gi√† in uso da un‚Äôaltra applicazione. ';
        }

        document.getElementById('errorText').innerHTML =
          msg +
          '<br><br><strong>Come risolvere:</strong>' +
          '<br><br><strong>Chrome/Edge:</strong> icona lucchetto ‚Üí Impostazioni sito ‚Üí Microfono ‚Üí Consenti' +
          '<br><br><strong>Firefox:</strong> icona microfono ‚Üí rimuovi blocco e ricarica' +
          '<br><br><strong>Safari:</strong> Impostazioni ‚Üí Siti ‚Üí Microfono ‚Üí Consenti';
      }
    }

    // ===== Start/Stop tuner =====
    function startTuner(stream) {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;

        microphone = audioContext.createMediaStreamSource(stream);
        scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

        microphone.connect(analyser);
        analyser.connect(scriptProcessor);
        scriptProcessor.connect(audioContext.destination);
        scriptProcessor.onaudioprocess = processAudio;

        isRunning = true;

        const btn = document.getElementById('startBtn');
        const display = document.getElementById('tunerDisplay');
        btn.textContent = '‚èπ Ferma';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-danger', 'listening');
        display.style.display = 'block';

        drawMeterScale();
        showFsPromptIfNeeded(); // propone fullscreen se landscape

      } catch (error) {
        alert('Errore nell‚Äôavvio dell‚Äôaccordatore: ' + error.message);
      }
    }

    function stopTuner() {
      try {
        if (scriptProcessor) {
          scriptProcessor.disconnect();
          scriptProcessor.onaudioprocess = null;
        }
        if (microphone) microphone.disconnect();
        if (analyser) analyser.disconnect();
        if (audioContext) audioContext.close();
      } catch(e){}

      isRunning = false;

      const btn = document.getElementById('startBtn');
      const display = document.getElementById('tunerDisplay');
      btn.textContent = 'üé§ Avvia Accordatore';
      btn.classList.remove('btn-danger', 'listening');
      btn.classList.add('btn-primary');
      display.style.display = 'none';

      zoomLevel = 1;
      stableCount = 0;

      // se si ferma, nascondi prompt fullscreen e esci fullscreen
      fsPrompt.classList.remove('show');
      exitFullscreen();
    }

    async function toggleTuner() {
      if (!isRunning) showMicrophoneModal();
      else stopTuner();
    }

    // ===== AUTO FULLSCREEN (landscape) =====
    const fsPrompt = document.getElementById('fsPrompt');
    const fsBtn = document.getElementById('fsBtn');

    function isLandscapePhone() {
      return window.matchMedia('(orientation: landscape)').matches && window.innerHeight <= 520;
    }
    function isFullscreenActive() {
      return !!document.fullscreenElement;
    }

    async function enterFullscreen() {
      try {
        await document.documentElement.requestFullscreen({ navigationUI: "hide" });
        fsPrompt.classList.remove('show');
      } catch (e) {
        console.warn('Fullscreen non disponibile:', e);
      }
    }

    async function exitFullscreen() {
      try {
        if (document.fullscreenElement) await document.exitFullscreen();
      } catch (e) {}
    }

    function showFsPromptIfNeeded() {
      if (isLandscapePhone() && isRunning && !isFullscreenActive()) {
        fsPrompt.classList.add('show');
      } else {
        fsPrompt.classList.remove('show');
      }
    }

    fsBtn.addEventListener('click', enterFullscreen);

    function handleOrientationUI() {
      if (!isLandscapePhone()) {
        fsPrompt.classList.remove('show');
        exitFullscreen(); // torna portrait -> esci
      } else {
        showFsPromptIfNeeded();
      }
    }

    window.addEventListener('orientationchange', () => setTimeout(handleOrientationUI, 150));
    window.addEventListener('resize', () => setTimeout(handleOrientationUI, 150));
    document.addEventListener('fullscreenchange', showFsPromptIfNeeded);

    // ===== PWA Service Worker (se presente) =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
